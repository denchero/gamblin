<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Expected Gambling Loss — Story + Simulator</title>

  <style>
    :root{
      --bg:#000;
      --fg:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.58);
      --muted2:rgba(255,255,255,.40);
      --line:rgba(255,255,255,.10);
      --panel:rgba(10,10,10,.72);
      --shadow: 0 24px 70px rgba(0,0,0,.75);
      --r:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font: 14px/1.45 var(--sans);
      letter-spacing:.12px;
      overflow-x:hidden;
    }

    /* subtle grain */
    body:before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.09;
      mix-blend-mode:overlay;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.22'/%3E%3C/svg%3E");
      z-index:0;
    }

    .scene{
      position:relative;
      z-index:1;
      perspective: 1200px;
      transform-style:preserve-3d;
    }

    /* Story / scroll */
    .snap{
      height:100vh;
      overflow-y:auto;
      scroll-snap-type: y mandatory;
      scroll-behavior:smooth;
      position:relative;
      z-index:2;
    }
    section{
      min-height:100vh;
      scroll-snap-align:start;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 26px 18px;
      position:relative;
      transform-style:preserve-3d;
    }

    /* HUD */
    .hud{
      position:fixed;
      top:14px;
      left:50%;
      transform: translateX(-50%);
      z-index:5;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border:1px solid var(--line);
      border-radius: 999px;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(8px);
    }
    .hud .dot{ width:8px; height:8px; border-radius:999px; background:rgba(255,255,255,.8); }
    .hud .t{ font: 12px/1 var(--mono); color: var(--muted); }
    .hud .bar{
      width: 140px; height: 8px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius:999px;
      overflow:hidden;
    }
    .hud .bar i{
      display:block; height:100%;
      width: 0%;
      background: rgba(255,255,255,.82);
      transition: width .25s ease;
    }

    /* Layout blocks */
    .hero{
      width:min(980px, 100%);
      transform: translateZ(40px);
    }
    .kicker{
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.22em;
      font-size:11px;
      margin-bottom:8px;
    }
    h1{
      margin:0;
      font-size: 30px;
      line-height: 1.05;
      font-weight: 860;
      letter-spacing:.2px;
    }
    .sub{
      margin-top: 10px;
      color:var(--muted);
      max-width: 82ch;
      font-size: 13px;
    }
    .pill{
      display:inline-flex;
      gap:10px;
      align-items:center;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding: 8px 12px;
      border-radius: 999px;
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
      margin-top: 10px;
      font-family: var(--mono);
    }
    .pill .pDot{
      width:8px; height:8px; border-radius:999px;
      background: rgba(255,255,255,.78);
      box-shadow: 0 0 0 5px rgba(255,255,255,.08);
    }

    .wrap{
      width:min(1040px, 100%);
      display:grid;
      grid-template-columns: 420px 1fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 960px){
      .wrap{ grid-template-columns: 1fr; }
    }

    .card{
      border:1px solid var(--line);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      transform-style:preserve-3d;
    }
    .inner{ padding: 16px; }
    .title{
      margin:0 0 12px;
      color:var(--muted);
      font-weight: 800;
      letter-spacing:.18em;
      text-transform:uppercase;
      font-size: 11px;
      font-family: var(--sans);
    }

    label{ color:var(--muted); }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin: 10px 0;
    }
    input[type="range"]{ width:100%; }
    input[type="number"], select{
      width: 190px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.55);
      color:var(--fg);
      outline:none;
      font-family: var(--mono);
    }

    .toggle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(0,0,0,.35);
      margin-top: 12px;
    }
    .toggle .left{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .toggle .left b{
      font-size: 12px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color: var(--muted);
      font-family: var(--sans);
    }
    .toggle .left span{
      color: var(--muted2);
      font-size: 12px;
      font-family: var(--sans);
    }
    .switch{
      position:relative;
      width: 54px;
      height: 30px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border:1px solid var(--line);
      cursor:pointer;
      flex:0 0 auto;
    }
    .switch i{
      position:absolute;
      top: 3px; left: 3px;
      width: 24px; height: 24px;
      border-radius: 999px;
      background: rgba(255,255,255,.92);
      transition: transform .18s ease;
      will-change: transform;
    }
    .switch.on i{ transform: translateX(24px); }

    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }
    @media (max-width: 600px){
      .split{ grid-template-columns: 1fr; }
    }

    .stat{
      border:1px solid var(--line);
      background: rgba(0,0,0,.45);
      border-radius: 16px;
      padding: 12px;
    }
    .stat .k{ color:var(--muted); font-size: 12px; font-family: var(--sans); }
    .stat .v{ font-size: 24px; font-weight: 900; margin-top: 2px; letter-spacing:.2px; font-family: var(--mono); }
    .stat .s{ color:var(--muted2); font-size: 12px; margin-top: 4px; font-family: var(--mono); }

    .bar{
      height: 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      overflow:hidden;
      margin-top: 10px;
    }
    .bar > i{
      display:block;
      height:100%;
      width:0%;
      background: rgba(255,255,255,.80);
      transition: width .35s ease;
    }

    .note{
      color:var(--muted2);
      font-size: 12px;
      margin-top: 12px;
      line-height:1.55;
      font-family: var(--sans);
    }

    .viz{
      border:1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      background: rgba(0,0,0,.35);
      padding: 12px;
      margin-top: 12px;
      overflow:hidden;
    }

    /* Scroll hint */
    .scrollHint{
      position:absolute;
      left:50%;
      bottom: 22px;
      transform: translateX(-50%);
      color: var(--muted2);
      font-size: 12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
      pointer-events:none;
      font-family: var(--sans);
    }
    .scrollHint i{
      display:inline-block;
      width: 18px; height: 28px;
      border:1px solid rgba(255,255,255,.22);
      border-radius: 999px;
      position:relative;
    }
    .scrollHint i:after{
      content:"";
      position:absolute;
      left:50%;
      top:6px;
      width: 4px; height: 6px;
      background: rgba(255,255,255,.45);
      border-radius: 99px;
      transform: translateX(-50%);
      animation: wheel 1.2s ease-in-out infinite;
    }
    @keyframes wheel{
      0%{ transform: translateX(-50%) translateY(0); opacity:.55; }
      70%{ transform: translateX(-50%) translateY(10px); opacity:.15; }
      100%{ opacity:.55; }
    }

    /* 3D tilt */
    .tilt{ transform: rotateX(0) rotateY(0) translateZ(0); will-change: transform; }

    /* ---------- HORSE GAME (upgraded) ---------- */
    .gameRow{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .gameControls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 12px;
      background: rgba(0,0,0,.40);
    }
    .gameControls .left, .gameControls .right{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.85);
      border-radius: 999px;
      padding: 10px 12px;
      cursor:pointer;
      font-family: var(--mono);
      font-size: 12px;
    }
    .btn:hover{ background: rgba(255,255,255,.08); }

    .track{
      position:relative;
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.01));
      height: 260px;
      overflow:hidden;
    }

    /* cinematic vignette */
    .track:before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(60% 120% at 20% 50%, rgba(255,255,255,.05), transparent 55%),
        radial-gradient(60% 120% at 80% 50%, rgba(0,0,0,.55), transparent 60%),
        linear-gradient(90deg, rgba(0,0,0,.35), transparent 20%, transparent 80%, rgba(0,0,0,.35));
      pointer-events:none;
    }

    .lane{
      position:absolute; left:0; right:0;
      height: 52px;
      border-top: 1px solid rgba(255,255,255,.07);
    }
    .finish{
      position:absolute;
      top:0; bottom:0;
      right: 150px;
      width: 2px;
      background: rgba(255,255,255,.30);
    }
    .finish:after{
      content:"";
      position:absolute;
      right:-10px; top:0; bottom:0;
      width: 20px;
      background:
        repeating-linear-gradient(
          180deg,
          rgba(255,255,255,.22) 0 10px,
          rgba(0,0,0,.00) 10px 20px
        );
      opacity:.35;
    }

    .bookie{
      position:absolute;
      top: 10px;
      right: 10px;
      width: 130px;
      height: 240px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.55);
      overflow:hidden;
      display:flex;
      align-items:flex-end;
      justify-content:center;
    }
    .bookie svg{
      width: 140px;
      height: 240px;
      display:block;
      opacity:.95;
    }
    .bookieLabel{
      position:absolute;
      top: 10px; left: 10px;
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(255,255,255,.60);
      letter-spacing:.08em;
      text-transform:uppercase;
      z-index:2;
    }

    .horseWrap{
      position:absolute;
      left: 14px;
      width: 140px;
      height: 40px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,.80);
      will-change: transform;
    }

    .horseSvg{
      width: 54px;
      height: 24px;
      overflow: visible;
    }

    /* gallop animation toggled with .run */
    .horseWrap.run .body{
      animation: bob 220ms infinite ease-in-out;
      transform-origin: 10px 12px;
    }
    .horseWrap.run .legA{
      animation: legA 160ms infinite ease-in-out;
      transform-origin: 10px 18px;
    }
    .horseWrap.run .legB{
      animation: legB 160ms infinite ease-in-out;
      transform-origin: 10px 18px;
    }
    .horseWrap.run .tail{
      animation: tail 240ms infinite ease-in-out;
      transform-origin: 6px 12px;
    }

    @keyframes bob{
      0%{ transform: translateY(0); }
      50%{ transform: translateY(1.5px); }
      100%{ transform: translateY(0); }
    }
    @keyframes legA{
      0%{ transform: rotate(18deg); }
      50%{ transform: rotate(-18deg); }
      100%{ transform: rotate(18deg); }
    }
    @keyframes legB{
      0%{ transform: rotate(-18deg); }
      50%{ transform: rotate(18deg); }
      100%{ transform: rotate(-18deg); }
    }
    @keyframes tail{
      0%{ transform: rotate(10deg); }
      50%{ transform: rotate(-10deg); }
      100%{ transform: rotate(10deg); }
    }

    /* dust particles */
    .dust{
      position:absolute;
      left: 10px;
      width: 120px;
      height: 52px;
      pointer-events:none;
      opacity:0;
    }
    .horseWrap.run + .dust{
      opacity:1;
    }
    .dust i{
      position:absolute;
      bottom: 10px;
      width: 6px; height: 6px;
      border-radius:999px;
      background: rgba(255,255,255,.14);
      animation: dust 420ms infinite ease-out;
    }
    .dust i:nth-child(2){ left: 20px; animation-delay: 80ms; opacity:.8; }
    .dust i:nth-child(3){ left: 34px; animation-delay: 160ms; opacity:.6; }
    .dust i:nth-child(4){ left: 50px; animation-delay: 240ms; opacity:.5; }
    @keyframes dust{
      0%{ transform: translateX(0) translateY(0) scale(0.9); opacity:.45; }
      100%{ transform: translateX(-24px) translateY(-10px) scale(1.2); opacity:0; }
    }

    /* money stream animation (created dynamically) */
    .money{
      position:absolute;
      width: 10px;
      height: 6px;
      border-radius: 3px;
      background: rgba(255,255,255,.82);
      box-shadow: 0 0 0 1px rgba(255,255,255,.18);
      pointer-events:none;
      opacity:0;
      will-change: transform, opacity;
    }

    /* bookie arm animation toggles */
    .bookie.pay .arm{
      animation: armPay 420ms ease-in-out 1;
      transform-origin: 74px 126px;
    }
    .bookie.take .arm{
      animation: armTake 420ms ease-in-out 1;
      transform-origin: 74px 126px;
    }
    @keyframes armPay{
      0%{ transform: rotate(0deg) translateX(0); }
      50%{ transform: rotate(-12deg) translateX(-3px); }
      100%{ transform: rotate(0deg) translateX(0); }
    }
    @keyframes armTake{
      0%{ transform: rotate(0deg) translateX(0); }
      50%{ transform: rotate(10deg) translateX(2px); }
      100%{ transform: rotate(0deg) translateX(0); }
    }

    .bank{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      font-family: var(--mono);
      color: rgba(255,255,255,.70);
      font-size: 12px;
      margin-top: 10px;
    }

    .bank strong{
      color: rgba(255,255,255,.92);
      font-weight: 800;
    }
  </style>
</head>

<body>
  <!-- HUD -->
  <div class="hud" aria-hidden="true">
    <span class="dot"></span>
    <span class="t" id="hudText">CHAPTER 1 / 6</span>
    <span class="bar"><i id="hudBar"></i></span>
  </div>

  <div class="scene">
    <div class="snap" id="snap">

      <!-- 1: Intro -->
      <section data-chapter="1">
        <div class="hero">
          <div class="kicker">Story mode • scroll to progress</div>
          <h1>Money doesn’t vanish.<br/>It leaks.</h1>
          <div class="sub">
            Feed the model in stages. If you provide <span style="font-family:var(--mono)">bet/week</span>, the £ result is driven by wager maths — not age or gender.
          </div>
          <div class="pill"><span class="pDot"></span> ASSUMPTION: gambles this year</div>
        </div>
        <div class="scrollHint"><i></i> scroll</div>
      </section>

      <!-- 2: Bet/week -->
      <section data-chapter="2">
        <div class="wrap">
          <div class="card tilt" id="cBet">
            <div class="inner">
              <div class="title">Stage 1 — How much do you stake?</div>

              <div class="toggle">
                <div class="left">
                  <b>Use bet/week</b>
                  <span>Turns on behavior-driven estimate (age/sex won’t change £).</span>
                </div>
                <div class="switch" id="betSwitch" role="button" aria-label="Toggle bet/week"><i></i></div>
              </div>

              <div class="row" id="betRow" style="display:none; margin-top:12px;">
                <label for="betPerWeek">Bet/week (£)</label>
                <input id="betPerWeek" type="number" min="0" step="5" placeholder="e.g. 50" />
              </div>

              <div class="row" style="margin-top:12px;">
                <label for="sportKey">Bet type</label>
                <select id="sportKey" aria-label="Loss-rate preset">
                  <option value="soccer">Soccer-like</option>
                  <option value="tennis">Tennis-like</option>
                  <option value="racing">Horse-racing-like</option>
                  <option value="greyhound">Greyhound-like</option>
                </select>
              </div>

              <div class="note">
                “Bet type” is a long-run expected loss rate proxy (margin / realized loss rate).
              </div>
            </div>
          </div>

          <div class="card tilt" id="vBet">
            <div class="inner">
              <div class="title">Turnover</div>
              <div class="viz">
                <svg viewBox="0 0 520 180" width="100%" height="180" aria-label="Turnover tank">
                  <rect x="18" y="20" width="300" height="120" rx="18" fill="none" stroke="rgba(255,255,255,.28)" stroke-width="2"/>
                  <rect x="18" y="20" width="300" height="120" rx="18" fill="rgba(255,255,255,.05)"/>
                  <text x="28" y="54" fill="rgba(255,255,255,.55)" font-size="12" font-family="ui-monospace, monospace">TURNOVER</text>

                  <clipPath id="tankClip"><rect x="18" y="20" width="300" height="120" rx="18"/></clipPath>
                  <rect id="tankFill" x="18" y="140" width="300" height="0" fill="rgba(255,255,255,.75)" clip-path="url(#tankClip)"/>

                  <rect x="340" y="68" width="90" height="20" rx="10" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.22)"/>
                  <circle cx="338" cy="78" r="12" fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.22)"/>

                  <path id="leakPath" d="M430 78 C460 90, 470 110, 492 132" fill="none" stroke="rgba(255,255,255,.75)" stroke-width="3" stroke-linecap="round" opacity="0.0"/>
                  <text x="340" y="52" fill="rgba(255,255,255,.55)" font-size="12" font-family="ui-monospace, monospace">LEAK RATE</text>
                  <text id="leakRateLabel" x="340" y="112" fill="rgba(255,255,255,.85)" font-size="14" font-family="ui-monospace, monospace">—</text>
                </svg>
              </div>

              <div class="note" style="font-family:var(--mono)" id="betSummary">Toggle bet/week to see turnover fill.</div>
            </div>
          </div>
        </div>
      </section>

      <!-- 3: Income -->
      <section data-chapter="3">
        <div class="wrap">
          <div class="card tilt" id="cIncome">
            <div class="inner">
              <div class="title">Stage 2 — Disposable income</div>
              <div class="row">
                <label for="income">Disposable income (£/year)</label>
                <input id="income" type="number" min="0" step="50" value="20000" />
              </div>
              <div class="note">Guardrails prevent absurd outputs when income is tiny.</div>
            </div>
          </div>

          <div class="card tilt" id="vIncome">
            <div class="inner">
              <div class="title">Budget rail</div>
              <div class="viz">
                <svg viewBox="0 0 520 180" width="100%" height="180" aria-label="Budget rail">
                  <text x="18" y="32" fill="rgba(255,255,255,.55)" font-size="12" font-family="ui-monospace, monospace">DISPOSABLE INCOME</text>
                  <rect x="18" y="56" width="484" height="16" rx="8" fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.12)"/>
                  <rect id="incomeBar" x="18" y="56" width="0" height="16" rx="8" fill="rgba(255,255,255,.75)"/>
                  <text id="incomeLabel" x="18" y="104" fill="rgba(255,255,255,.85)" font-size="16" font-family="ui-monospace, monospace">—</text>
                  <text x="18" y="136" fill="rgba(255,255,255,.45)" font-size="12" font-family="ui-monospace, monospace">
                    (scaled to £0 → £50k for display)
                  </text>
                </svg>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- 4: Demographics -->
      <section data-chapter="4">
        <div class="wrap">
          <div class="card tilt" id="cDemo">
            <div class="inner">
              <div class="title">Stage 3 — Demographics</div>

              <div class="row">
                <label for="age">Age</label>
                <div style="font-family:var(--mono)" id="ageVal">30</div>
              </div>
              <input id="age" type="range" min="18" max="90" value="30" />

              <div class="row" style="margin-top:12px;">
                <label for="sex">Sex</label>
                <select id="sex">
                  <option value="male">male</option>
                  <option value="female">female</option>
                </select>
              </div>

              <div class="note" id="demoNote">
                If bet/week is ON, these do not change the £ outcome.
              </div>
            </div>
          </div>

          <div class="card tilt" id="vDemo">
            <div class="inner">
              <div class="title">Impact switch</div>
              <div class="viz">
                <svg viewBox="0 0 520 180" width="100%" height="180" aria-label="Demographic effect">
                  <text x="18" y="32" fill="rgba(255,255,255,.55)" font-size="12" font-family="ui-monospace, monospace">EFFECT ON £ OUTCOME</text>
                  <text id="demoEffect" x="18" y="72" fill="rgba(255,255,255,.88)" font-size="22" font-family="ui-monospace, monospace">—</text>
                  <text id="demoEffect2" x="18" y="102" fill="rgba(255,255,255,.55)" font-size="12" font-family="ui-monospace, monospace">—</text>

                  <rect x="18" y="126" width="300" height="34" rx="17" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.12)"/>
                  <circle id="demoKnob" cx="35" cy="143" r="12" fill="rgba(255,255,255,.85)"/>
                  <text x="64" y="148" fill="rgba(255,255,255,.55)" font-size="12" font-family="ui-monospace, monospace">
                    bet/week OFF → demographics ON
                  </text>
                </svg>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- 5: Result -->
      <section data-chapter="5">
        <div class="wrap">
          <div class="card tilt" id="cResult">
            <div class="inner">
              <div class="title">Final — What leaks out?</div>

              <div class="split">
                <div class="stat">
                  <div class="k">Expected annual net loss</div>
                  <div class="v" id="expLoss">—</div>
                  <div class="s" id="band">—</div>
                  <div class="bar"><i id="posBar"></i></div>
                </div>

                <div class="stat">
                  <div class="k">Loss as % of income</div>
                  <div class="v" id="pctIncome">—</div>
                  <div class="s" id="modeLine">—</div>
                  <div class="bar"><i id="pctBar"></i></div>
                </div>
              </div>

              <div class="note" style="font-family:var(--mono)" id="capLine">CAPS: —</div>
              <div class="note" id="bananaLine">You could buy: —</div>
              <div class="note">Banana math is intentionally dumb: it’s for intuition, not economics.</div>
            </div>
          </div>

          <div class="card tilt" id="cSports">
            <div class="inner">
              <div class="title">Where you’re most likely to leak money</div>
              <div class="note" style="margin-top:-4px;">“Leak size” = expected loss-rate proxy. Higher = worse value on average.</div>

              <div class="viz">
                <svg viewBox="0 0 520 220" width="100%" height="220" aria-label="Leak map">
                  <text x="18" y="30" fill="rgba(255,255,255,.55)" font-size="12" font-family="ui-monospace, monospace">LEAK MAP</text>
                  <g id="sportPipes" transform="translate(18,52)"></g>
                  <text id="riskExplain" x="18" y="206" fill="rgba(255,255,255,.55)" font-size="12" font-family="ui-monospace, monospace">—</text>
                </svg>
              </div>

              <div class="note" style="font-family:var(--mono)" id="topRisk">—</div>
            </div>
          </div>
        </div>
      </section>

      <!-- 6: Horse simulator -->
      <section data-chapter="6">
        <div class="wrap">
          <div class="card tilt" id="cGame">
            <div class="inner">
              <div class="title">Bonus — Horse racing simulator</div>
              <div class="note" style="margin-top:-4px;">Pick a horse. Bet. Watch the bookie win in the long run.</div>

              <div class="gameRow">
                <div class="gameControls">
                  <div class="left">
                    <label>Pick</label>
                    <select id="pickHorse" style="width:160px;">
                      <option value="0">Horse 1</option>
                      <option value="1">Horse 2</option>
                      <option value="2">Horse 3</option>
                      <option value="3">Horse 4</option>
                      <option value="4">Horse 5</option>
                    </select>

                    <label>Stake (£)</label>
                    <input id="stake" type="number" min="1" step="1" value="5" style="width:110px;" />

                    <label>Overround</label>
                    <select id="overround" style="width:140px;">
                      <option value="1.05">105% (tight)</option>
                      <option value="1.12" selected>112% (typical-ish)</option>
                      <option value="1.20">120% (fat book)</option>
                    </select>
                  </div>

                  <div class="right">
                    <button class="btn" id="raceBtn">Run 1 race</button>
                    <button class="btn" id="sim1kBtn">Run 1,000</button>
                    <button class="btn" id="sim10kBtn">Run 10,000</button>
                    <button class="btn" id="resetBankBtn">Reset</button>
                  </div>
                </div>

                <div class="track" id="track">
                  <div class="finish"></div>

                  <div class="bookie" id="bookie">
                    <div class="bookieLabel" id="oddsBanner">Overround: —</div>
                    <!-- bookie booth + character -->
                    <svg viewBox="0 0 140 240" aria-label="Bookie">
                      <!-- booth -->
                      <rect x="10" y="30" width="120" height="170" rx="14" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.12)"/>
                      <rect x="10" y="160" width="120" height="40" rx="12" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.12)"/>
                      <text x="24" y="56" fill="rgba(255,255,255,.55)" font-size="10" font-family="ui-monospace, monospace">BOOKIE</text>
                      <!-- head -->
                      <circle cx="74" cy="92" r="16" fill="rgba(255,255,255,.82)"/>
                      <!-- hat -->
                      <rect x="58" y="72" width="32" height="10" rx="4" fill="rgba(255,255,255,.25)"/>
                      <rect x="54" y="80" width="40" height="6" rx="3" fill="rgba(255,255,255,.18)"/>
                      <!-- body -->
                      <rect x="60" y="110" width="28" height="32" rx="10" fill="rgba(255,255,255,.25)"/>
                      <!-- arm -->
                      <rect class="arm" x="84" y="118" width="30" height="8" rx="4" fill="rgba(255,255,255,.35)"/>
                      <!-- money stack -->
                      <rect x="94" y="174" width="24" height="10" rx="3" fill="rgba(255,255,255,.20)"/>
                      <rect x="92" y="182" width="28" height="10" rx="3" fill="rgba(255,255,255,.26)"/>
                      <rect x="90" y="190" width="32" height="10" rx="3" fill="rgba(255,255,255,.32)"/>
                      <!-- eyes -->
                      <circle cx="69" cy="90" r="2" fill="rgba(0,0,0,.7)"/>
                      <circle cx="79" cy="90" r="2" fill="rgba(0,0,0,.7)"/>
                    </svg>
                  </div>

                  <div class="lane" style="top:52px;"></div>
                  <div class="lane" style="top:104px;"></div>
                  <div class="lane" style="top:156px;"></div>
                  <div class="lane" style="top:208px;"></div>

                  <!-- horses (SVG + dust) -->
                  <div class="horseWrap" id="h0" style="top:10px;">
                    <span>H1</span>
                    <svg class="horseSvg" viewBox="0 0 60 28" aria-hidden="true">
                      <g class="body">
                        <ellipse cx="28" cy="14" rx="12" ry="8" fill="rgba(255,255,255,.78)"/>
                        <circle cx="41" cy="12" r="5" fill="rgba(255,255,255,.78)"/>
                        <rect x="18" y="6" width="6" height="8" rx="3" fill="rgba(255,255,255,.55)"/>
                        <g class="tail">
                          <path d="M16 14 C10 10, 10 18, 16 16" stroke="rgba(255,255,255,.55)" stroke-width="2" fill="none" stroke-linecap="round"/>
                        </g>
                        <g class="legA">
                          <path d="M24 20 L20 26" stroke="rgba(255,255,255,.55)" stroke-width="2" stroke-linecap="round"/>
                          <path d="M32 20 L28 26" stroke="rgba(255,255,255,.55)" stroke-width="2" stroke-linecap="round"/>
                        </g>
                        <g class="legB">
                          <path d="M28 20 L24 26" stroke="rgba(255,255,255,.35)" stroke-width="2" stroke-linecap="round"/>
                          <path d="M36 20 L32 26" stroke="rgba(255,255,255,.35)" stroke-width="2" stroke-linecap="round"/>
                        </g>
                      </g>
                    </svg>
                    <span id="o0">—</span>
                  </div>
                  <div class="dust"><i style="left:14px"></i><i></i><i></i><i></i></div>

                  <div class="horseWrap" id="h1" style="top:62px;">
                    <span>H2</span>
                    <svg class="horseSvg" viewBox="0 0 60 28" aria-hidden="true">
                      <g class="body">
                        <ellipse cx="28" cy="14" rx="12" ry="8" fill="rgba(255,255,255,.78)"/>
                        <circle cx="41" cy="12" r="5" fill="rgba(255,255,255,.78)"/>
                        <rect x="18" y="6" width="6" height="8" rx="3" fill="rgba(255,255,255,.55)"/>
                        <g class="tail">
                          <path d="M16 14 C10 10, 10 18, 16 16" stroke="rgba(255,255,255,.55)" stroke-width="2" fill="none" stroke-linecap="round"/>
                        </g>
                        <g class="legA">
                          <path d="M24 20 L20 26" stroke="rgba(255,255,255,.55)" stroke-width="2" stroke-linecap="round"/>
                          <path d="M32 20 L28 26" stroke="rgba(255,255,255,.55)" stroke-width="2" stroke-linecap="round"/>
                        </g>
                        <g class="legB">
                          <path d="M28 20 L24 26" stroke="rgba(255,255,255,.35)" stroke-width="2" stroke-linecap="round"/>
                          <path d="M36 20 L32 26" stroke="rgba(255,255,255,.35)" stroke-width="2" stroke-linecap="round"/>
                        </g>
                      </g>
                    </svg>
                    <span id="o1">—</span>
                  </div>
                  <div class="dust"><i style="left:14px"></i><i></i><i></i><i></i></div>

                  <div class="horseWrap" id="h2" style="top:114px;">
                    <span>H3</span>
                    <svg class="horseSvg" viewBox="0 0 60 28" aria-hidden="true">
                      <g class="body">
                        <ellipse cx="28" cy="14" rx="12" ry="8" fill="rgba(255,255,255,.78)"/>
                        <circle cx="41" cy="12" r="5" fill="rgba(255,255,255,.78)"/>
                        <rect x="18" y="6" width="6" height="8" rx="3" fill="rgba(255,255,255,.55)"/>
                        <g class="tail">
                          <path d="M16 14 C10 10, 10 18, 16 16" stroke="rgba(255,255,255,.55)" stroke-width="2" fill="none" stroke-linecap="round"/>
                        </g>
                        <g class="legA">
                          <path d="M24 20 L20 26" stroke="rgba(255,255,255,.55)" stroke-width="2" stroke-linecap="round"/>
                          <path d="M32 20 L28 26" stroke="rgba(255,255,255,.55)" stroke-width="2" stroke-linecap="round"/>
                        </g>
                        <g class="legB">
                          <path d="M28 20 L24 26" stroke="rgba(255,255,255,.35)" stroke-width="2" stroke-linecap="round"/>
                          <path d="M36 20 L32 26" stroke="rgba(255,255,255,.35)" stroke-width="2" stroke-linecap="round"/>
                        </g>
                      </g>
                    </svg>
                    <span id="o2">—</span>
                  </div>
                  <div class="dust"><i style="left:14px"></i><i></i><i></i><i></i></div>

                  <div class="horseWrap" id="h3" style="top:166px;">
                    <span>H4</span>
                    <svg class="horseSvg" viewBox="0 0 60 28" aria-hidden="true">
                      <g class="body">
                        <ellipse cx="28" cy="14" rx="12" ry="8" fill="rgba(255,255,255,.78)"/>
                        <circle cx="41" cy="12" r="5" fill="rgba(255,255,255,.78)"/>
                        <rect x="18" y="6" width="6" height="8" rx="3" fill="rgba(255,255,255,.55)"/>
                        <g class="tail">
                          <path d="M16 14 C10 10, 10 18, 16 16" stroke="rgba(255,255,255,.55)" stroke-width="2" fill="none" stroke-linecap="round"/>
                        </g>
                        <g class="legA">
                          <path d="M24 20 L20 26" stroke="rgba(255,255,255,.55)" stroke-width="2" stroke-linecap="round"/>
                          <path d="M32 20 L28 26" stroke="rgba(255,255,255,.55)" stroke-width="2" stroke-linecap="round"/>
                        </g>
                        <g class="legB">
                          <path d="M28 20 L24 26" stroke="rgba(255,255,255,.35)" stroke-width="2" stroke-linecap="round"/>
                          <path d="M36 20 L32 26" stroke="rgba(255,255,255,.35)" stroke-width="2" stroke-linecap="round"/>
                        </g>
                      </g>
                    </svg>
                    <span id="o3">—</span>
                  </div>
                  <div class="dust"><i style="left:14px"></i><i></i><i></i><i></i></div>

                  <div class="horseWrap" id="h4" style="top:218px;">
                    <span>H5</span>
                    <svg class="horseSvg" viewBox="0 0 60 28" aria-hidden="true">
                      <g class="body">
                        <ellipse cx="28" cy="14" rx="12" ry="8" fill="rgba(255,255,255,.78)"/>
                        <circle cx="41" cy="12" r="5" fill="rgba(255,255,255,.78)"/>
                        <rect x="18" y="6" width="6" height="8" rx="3" fill="rgba(255,255,255,.55)"/>
                        <g class="tail">
                          <path d="M16 14 C10 10, 10 18, 16 16" stroke="rgba(255,255,255,.55)" stroke-width="2" fill="none" stroke-linecap="round"/>
                        </g>
                        <g class="legA">
                          <path d="M24 20 L20 26" stroke="rgba(255,255,255,.55)" stroke-width="2" stroke-linecap="round"/>
                          <path d="M32 20 L28 26" stroke="rgba(255,255,255,.55)" stroke-width="2" stroke-linecap="round"/>
                        </g>
                        <g class="legB">
                          <path d="M28 20 L24 26" stroke="rgba(255,255,255,.35)" stroke-width="2" stroke-linecap="round"/>
                          <path d="M36 20 L32 26" stroke="rgba(255,255,255,.35)" stroke-width="2" stroke-linecap="round"/>
                        </g>
                      </g>
                    </svg>
                    <span id="o4">—</span>
                  </div>
                  <div class="dust"><i style="left:14px"></i><i></i><i></i><i></i></div>

                </div>

                <div class="bank">
                  <div>Bankroll: <strong id="bank">£100.00</strong></div>
                  <div>Races: <strong id="races">0</strong></div>
                  <div>ROI: <strong id="roi">0.00%</strong></div>
                  <div id="lastResult">Last: —</div>
                </div>

                <div class="note">
                  The “house edge” comes from overround: bookmaker-implied probabilities sum to > 1.
                </div>
              </div>
            </div>
          </div>

          <div class="card tilt" id="cOutro">
            <div class="inner">
              <div class="title">Done</div>
              <div class="sub" style="margin-top:0;">Over a big enough sample, the maths wins.</div>
              <div class="pill"><span class="pDot"></span> scroll up and mess with it</div>
            </div>
          </div>
        </div>
      </section>

    </div>
  </div>

  <script>
    // Banana stat: keep it dumb & stable
    const BANANA_PRICE_GBP = 0.25; // rough “single banana” price for the joke
    function bananasFromLoss(loss){
      const n = Math.max(0, Math.round(loss / BANANA_PRICE_GBP));
      return n.toLocaleString();
    }

    // Fallback demographic anchors (used only if bet/week OFF)
    const LOSS_PGSI0   = 196.95;
    const LOSS_PGSI1_4 = 955.21;
    const LOSS_PGSI5P  = 2506.91;
    const AT_RISK_LOSS_PCT_INCOME   = 0.023;
    const HIGH_RISK_LOSS_PCT_INCOME = 0.059;

    const PGSI_BY_SEX = {
      male:   { low_1_2: 0.165, mod_3_7: 0.066, prob_8p: 0.060 },
      female: { low_1_2: 0.130, mod_3_7: 0.039, prob_8p: 0.028 },
    };
    const YOUNG_MULT = 2.27;
    const OLD_MULT   = 0.11;

    // Sport leak presets (keys avoid float-equality bugs)
    const SPORT_RISK = {
      soccer:    { name:"Soccer",    rate:0.078, note:"~7.8% leak proxy" },
      tennis:    { name:"Tennis",    rate:0.075, note:"~7.5% leak proxy" },
      racing:    { name:"Racing",    rate:0.120, note:"fatter books vary" },
      greyhound: { name:"Greyhound", rate:0.260, note:"very fat books" },
    };
    const SPORT_ORDER = ["greyhound","racing","soccer","tennis"];

    const $ = (id) => document.getElementById(id);
    const clamp = (x, lo, hi) => Math.max(lo, Math.min(hi, x));
    const lerp = (a,b,t) => a + (b-a)*t;

    // HUD + chapters
    const snap = $("snap");
    const sections = Array.from(document.querySelectorAll("section[data-chapter]"));
    const hudText = $("hudText");
    const hudBar = $("hudBar");

    function updateHUD(){
      const st = snap.scrollTop;
      const max = Math.max(1, snap.scrollHeight - snap.clientHeight);
      hudBar.style.width = ((st / max) * 100).toFixed(1) + "%";

      let best = 0, bestDist = Infinity;
      for (let i=0;i<sections.length;i++){
        const d = Math.abs(sections[i].offsetTop - st);
        if (d < bestDist){ bestDist = d; best = i; }
      }
      hudText.textContent = `CHAPTER ${best+1} / ${sections.length}`;
    }
    snap.addEventListener("scroll", updateHUD, { passive:true });

    // 3D tilt
    function addTilt(card){
      const onMove = (ev) => {
        const r = card.getBoundingClientRect();
        const x = (ev.clientX - r.left) / r.width - 0.5;
        const y = (ev.clientY - r.top) / r.height - 0.5;
        card.style.transform = `rotateX(${(-y*6).toFixed(2)}deg) rotateY(${(x*8).toFixed(2)}deg) translateZ(6px)`;
      };
      const onLeave = () => { card.style.transform = `rotateX(0deg) rotateY(0deg) translateZ(0px)`; };
      card.addEventListener("mousemove", onMove);
      card.addEventListener("mouseleave", onLeave);
    }

    // Model pieces
    let betEnabled = false;

    function pgsiMixAmongGamblers(age, sex){
      const base = PGSI_BY_SEX[sex] || PGSI_BY_SEX.male;
      const m = { ...base };

      let ageMult;
      if (age <= 21) ageMult = YOUNG_MULT;
      else if (age >= 78) ageMult = OLD_MULT;
      else ageMult = lerp(YOUNG_MULT, OLD_MULT, (age - 21) / (78 - 21));

      m.prob_8p = clamp(m.prob_8p * ageMult, 0, 0.35);

      const scale = (1 - m.prob_8p) / (1 - base.prob_8p);
      m.low_1_2 *= scale;
      m.mod_3_7 *= scale;

      m.pgsi_0 = clamp(1 - (m.low_1_2 + m.mod_3_7 + m.prob_8p), 0, 1);
      return m;
    }

    function mapToLossBands(m){
      const p34 = m.mod_3_7 * (2/5);
      const p57 = m.mod_3_7 * (3/5);
      return { p0:m.pgsi_0, p14:m.low_1_2 + p34, p5p:p57 + m.prob_8p };
    }

    function blendedLoss(poundsAnchor, income, pctAnchor){
      if (!(income > 0)) return poundsAnchor;
      const incomeBased = income * pctAnchor;

      const t = clamp((income - 1000) / 9000, 0, 1);
      const wAnchor = t;
      const wIncome = 1 - t;

      const a = Math.max(1e-9, poundsAnchor);
      const b = Math.max(1e-9, incomeBased);
      return Math.exp(Math.log(a)*wAnchor + Math.log(b)*wIncome);
    }

    function expectedLossDemographic(mix, income){
      const { p0, p14, p5p } = mapToLossBands(mix);
      const loss0  = LOSS_PGSI0;
      const loss14 = blendedLoss(LOSS_PGSI1_4, income, AT_RISK_LOSS_PCT_INCOME);
      const loss5p = blendedLoss(LOSS_PGSI5P,  income, HIGH_RISK_LOSS_PCT_INCOME);
      return p0*loss0 + p14*loss14 + p5p*loss5p;
    }

    function expectedLossFromTurnover(betPerWeek, lossRate){
      const turnover = Math.max(0, betPerWeek) * 52;
      return turnover * clamp(lossRate, 0, 0.40);
    }

    function applyCaps(expLoss, income, betPerWeek){
      const caps = [];
      let x = expLoss;

      if (betPerWeek > 0){
        const stakeCap = betPerWeek * 52;
        if (x > stakeCap){ x = stakeCap; caps.push("stake/yr"); }
      }
      if (income > 0 && income < 2000){
        const incomeCap = income * 0.60;
        if (x > incomeCap){ x = incomeCap; caps.push("low-income"); }
      }
      if (income > 0){
        const hard = income * 2.0;
        if (x > hard){ x = hard; caps.push("hard-income"); }
      }
      return { value:x, caps: caps.length ? caps.join("+") : "none" };
    }

    function outcomeBand(exp){ return [exp*0.4, exp*2.0]; }
    function fmtGBP0(x){ return "£" + x.toLocaleString(undefined, { maximumFractionDigits: 0 }); }

    // Visual fixes
    function updateTank(betPerWeek, rate){
      const fill = $("tankFill");
      const leakPath = $("leakPath");
      const leakRateLabel = $("leakRateLabel");
      const betSummary = $("betSummary");

      if (!betEnabled){
        fill.setAttribute("y","140");
        fill.setAttribute("height","0");
        leakPath.setAttribute("opacity","0.0");
        leakRateLabel.textContent = "—";
        betSummary.textContent = "Toggle bet/week to see turnover fill.";
        return;
      }

      const bet = Math.max(0, betPerWeek || 0);
      const turnover = bet * 52;

      const maxBet = 250;
      const pct = clamp(bet / maxBet, 0, 1);
      const h = 120 * pct;

      fill.setAttribute("y", String(140 - h));
      fill.setAttribute("height", String(h));

      const showLeak = bet > 0;
      leakPath.setAttribute("opacity", showLeak ? "0.9" : "0.0");
      leakRateLabel.textContent = `lossRate: ${(rate*100).toFixed(1)}%`;

      betSummary.textContent = bet > 0
        ? `Turnover ≈ £${turnover.toFixed(0)}/yr (from £${bet.toFixed(0)}/wk)`
        : "Enter bet/week to see turnover and leak.";
    }

    function updateIncomeViz(income){
      const max = 50000;
      const w = 484 * clamp((income || 0) / max, 0, 1);
      $("incomeBar").setAttribute("width", String(w));
      $("incomeLabel").textContent = income > 0 ? `£${income.toFixed(0)}/yr` : "—";
    }

    function renderSportPipes(selectedKey){
      const g = $("sportPipes");
      g.innerHTML = "";

      const ranked = SPORT_ORDER
        .map(k => ({ key:k, ...SPORT_RISK[k] }))
        .sort((a,b)=>b.rate-a.rate);

      const maxRate = ranked[0].rate;
      const minRate = ranked[ranked.length-1].rate;

      ranked.forEach((s, i) => {
        const y = i * 36;
        const t = (s.rate - minRate) / (maxRate - minRate + 1e-9);

        const row = document.createElementNS("http://www.w3.org/2000/svg","g");
        row.setAttribute("transform", `translate(0,${y})`);

        const label = document.createElementNS("http://www.w3.org/2000/svg","text");
        label.setAttribute("x","0");
        label.setAttribute("y","14");
        label.setAttribute("fill","rgba(255,255,255,.78)");
        label.setAttribute("font-size","12");
        label.setAttribute("font-family","ui-monospace, monospace");
        label.textContent = s.name;

        const pipe = document.createElementNS("http://www.w3.org/2000/svg","rect");
        pipe.setAttribute("x","140");
        pipe.setAttribute("y","5");
        pipe.setAttribute("width","290");
        pipe.setAttribute("height","14");
        pipe.setAttribute("rx","7");
        pipe.setAttribute("fill","rgba(255,255,255,.06)");
        pipe.setAttribute("stroke","rgba(255,255,255,.18)");

        const leak = document.createElementNS("http://www.w3.org/2000/svg","rect");
        leak.setAttribute("x","140");
        leak.setAttribute("y","5");
        leak.setAttribute("width", String(290 * t));
        leak.setAttribute("height","14");
        leak.setAttribute("rx","7");
        leak.setAttribute("fill", s.key === selectedKey ? "rgba(255,255,255,.92)" : "rgba(255,255,255,.62)");

        const pct = document.createElementNS("http://www.w3.org/2000/svg","text");
        pct.setAttribute("x","450");
        pct.setAttribute("y","16");
        pct.setAttribute("fill","rgba(255,255,255,.78)");
        pct.setAttribute("font-size","12");
        pct.setAttribute("font-family","ui-monospace, monospace");
        pct.textContent = `${(s.rate*100).toFixed(1)}%`;

        row.appendChild(label);
        row.appendChild(pipe);
        row.appendChild(leak);
        row.appendChild(pct);
        g.appendChild(row);
      });

      const top = ranked[0];
      $("topRisk").textContent = `Highest leak proxy: ${top.name} (${(top.rate*100).toFixed(1)}%) — ${top.note}`;
      $("riskExplain").textContent = `Selected: ${SPORT_RISK[selectedKey].name} (${(SPORT_RISK[selectedKey].rate*100).toFixed(1)}%)`;
    }

    function setBetUI(){
      $("betSwitch").classList.toggle("on", betEnabled);
      $("betRow").style.display = betEnabled ? "flex" : "none";
      if (!betEnabled) $("betPerWeek").value = "";
    }

    function recalc(){
      const age = Number($("age").value);
      const sex = $("sex").value;
      const income = Number($("income").value);
      const bet = betEnabled ? Number($("betPerWeek").value || 0) : 0;

      const sportKey = $("sportKey").value;
      const rate = SPORT_RISK[sportKey].rate;

      $("ageVal").textContent = String(age);

      updateIncomeViz(income);
      updateTank(bet, rate);
      renderSportPipes(sportKey);

      if (betEnabled && bet > 0){
        $("demoEffect").textContent = "OFF";
        $("demoEffect2").textContent = "bet/week ON → demographics do not change £";
        $("demoKnob").setAttribute("cx","260");
      } else {
        $("demoEffect").textContent = "ON";
        $("demoEffect2").textContent = "bet/week OFF → demographics influence fallback model";
        $("demoKnob").setAttribute("cx","35");
      }

      const mix = pgsiMixAmongGamblers(age, sex);
      let exp, modeLine;

      if (betEnabled && bet > 0){
        exp = expectedLossFromTurnover(bet, rate);
        modeLine = `Mode: turnover × lossRate (${(rate*100).toFixed(1)}%)`;
      } else {
        exp = expectedLossDemographic(mix, income);
        modeLine = `Mode: demographic fallback (no bet/week)`;
      }

      const capped = applyCaps(exp, income, bet);
      exp = capped.value;

      const [lo, hi] = outcomeBand(exp);

      $("expLoss").textContent = fmtGBP0(exp);
      $("band").textContent = `${fmtGBP0(lo)} — ${fmtGBP0(hi)} (loose band)`;
      $("modeLine").textContent = modeLine;
      $("capLine").textContent = `CAPS: ${capped.caps}`;

      const pos = clamp((exp - lo) / (hi - lo), 0, 1);
      $("posBar").style.width = (pos * 100).toFixed(1) + "%";

      if (income > 0){
        const pct = exp / income;
        $("pctIncome").textContent = (pct * 100).toFixed(2) + "%";
        $("pctBar").style.width = (clamp(pct / 0.12, 0, 1) * 100).toFixed(1) + "%";
      } else {
        $("pctIncome").textContent = "—";
        $("pctBar").style.width = "0%";
      }

      $("bananaLine").innerHTML = `You could buy: <span style="font-family:var(--mono); color:rgba(255,255,255,.88)">${bananasFromLoss(exp)} bananas</span> 🍌`;
    }

    // ---------- Horse game (visual upgrade + bookie money) ----------
    let bank = 100;
    let races = 0;
    let totalStaked = 0;

    let trueProbs = [0.25, 0.22, 0.20, 0.18, 0.15];
    let bookOdds  = [3.0, 3.5, 4.0, 4.5, 5.0];

    function randDirichlet5(){
      const g = Array.from({length:5}, () => -Math.log(Math.max(1e-9, Math.random())));
      const s = g.reduce((a,b)=>a+b,0);
      return g.map(x=>x/s);
    }

    function computeBookOdds(overround){
      const q = trueProbs.map(p => p * overround);
      return q.map(x => 1 / x);
    }

    function fmtDecOdds(x){ return x.toFixed(2) + "x"; }

    function updateGameOddsBanner(){
      const ov = Number($("overround").value);
      $("oddsBanner").textContent = `Overround: ${(ov*100).toFixed(0)}%`;
    }

    function updateGameOddsUI(){
      $("o0").textContent = fmtDecOdds(bookOdds[0]);
      $("o1").textContent = fmtDecOdds(bookOdds[1]);
      $("o2").textContent = fmtDecOdds(bookOdds[2]);
      $("o3").textContent = fmtDecOdds(bookOdds[3]);
      $("o4").textContent = fmtDecOdds(bookOdds[4]);
      updateGameOddsBanner();
    }

    function chooseWinner(){
      const r = Math.random();
      let cum = 0;
      for (let i=0;i<trueProbs.length;i++){
        cum += trueProbs[i];
        if (r <= cum) return i;
      }
      return trueProbs.length - 1;
    }

    function resetHorses(){
      for (let i=0;i<5;i++){
        const h = $("h"+i);
        h.classList.remove("run");
        h.style.transform = `translateX(0px)`;
        h.style.transition = "";
      }
    }

    function clearMoney(){
      document.querySelectorAll(".money").forEach(el => el.remove());
    }

    function moneyStream(fromX, fromY, toX, toY, count, ms){
      const track = $("track");
      const rect = track.getBoundingClientRect();

      for (let i=0;i<count;i++){
        const m = document.createElement("div");
        m.className = "money";
        track.appendChild(m);

        const sx = fromX - rect.left + (Math.random()*10 - 5);
        const sy = fromY - rect.top  + (Math.random()*10 - 5);
        const tx = toX   - rect.left + (Math.random()*16 - 8);
        const ty = toY   - rect.top  + (Math.random()*16 - 8);

        const delay = i * (ms / count) * 0.18;

        m.style.left = sx + "px";
        m.style.top  = sy + "px";
        m.style.opacity = "0";

        requestAnimationFrame(() => {
          m.style.transition =
            `transform ${ms}ms cubic-bezier(.2,.9,.2,1) ${delay}ms, opacity 180ms ease ${delay}ms`;
          m.style.opacity = "0.95";
          m.style.transform = `translate(${(tx - sx).toFixed(0)}px, ${(ty - sy).toFixed(0)}px)`;
        });

        // fade out near end
        setTimeout(() => {
          m.style.transition = `opacity 220ms ease`;
          m.style.opacity = "0";
        }, delay + ms - 220);

        setTimeout(() => m.remove(), delay + ms + 260);
      }
    }

    function settleBet(pick, stake, winner){
      races += 1;
      totalStaked += stake;
      bank -= stake;

      let payout = 0;
      const win = (pick === winner);
      if (win){
        payout = stake * (bookOdds[winner] - 1);
        bank += stake + payout;
      }

      $("bank").textContent = "£" + bank.toFixed(2);
      $("races").textContent = String(races);

      const roi = totalStaked > 0 ? ((bank - 100) / totalStaked) * 100 : 0;
      $("roi").textContent = roi.toFixed(2) + "%";

      $("lastResult").textContent = win
        ? `Last: WIN (Horse ${winner+1}) +£${payout.toFixed(2)}`
        : `Last: LOSS (Horse ${winner+1})`;

      // bookie animation + money
      const bookie = $("bookie");
      bookie.classList.remove("pay","take");
      void bookie.offsetWidth; // restart CSS animation

      const track = $("track").getBoundingClientRect();
      const bookieRect = bookie.getBoundingClientRect();

      // “player bank” target: use the bankroll text (approx)
      const bankRect = $("bank").getBoundingClientRect();

      if (win){
        bookie.classList.add("pay");
        moneyStream(
          bookieRect.left + 40, bookieRect.top + 120,
          bankRect.left + 20, bankRect.top + 10,
          14, 650
        );
      } else {
        bookie.classList.add("take");
        moneyStream(
          bankRect.left + 20, bankRect.top + 10,
          bookieRect.left + 40, bookieRect.top + 140,
          10, 520
        );
      }
    }

    function runRaceAnimated(pick, stake){
      clearMoney();

      const winner = chooseWinner();
      const track = $("track");
      const finishX = track.clientWidth - 150 - 160; // finish line offset minus horse width-ish
      const base = Math.max(120, finishX);

      const durations = [];
      for (let i=0;i<5;i++){
        const noise = (Math.random() * 0.25) + 0.95;
        const winBoost = (i === winner) ? 0.86 : 1.0;
        durations[i] = 1300 * noise * winBoost;
      }

      for (let i=0;i<5;i++){
        const h = $("h"+i);
        h.classList.add("run");
        h.style.transition = `transform ${durations[i].toFixed(0)}ms cubic-bezier(.2,.85,.2,1)`;
        h.style.transform = `translateX(${base}px)`;
      }

      const settleIn = Math.max(...durations) + 40;
      setTimeout(() => {
        settleBet(pick, stake, winner);
        setTimeout(resetHorses, 520);
      }, settleIn);
    }

    function runSim(n){
      const pick = Number($("pickHorse").value);
      const stake = Math.max(1, Number($("stake").value || 1));

      for (let i=0;i<n;i++){
        const winner = chooseWinner();
        races += 1;
        totalStaked += stake;
        bank -= stake;
        if (pick === winner){
          const payout = stake * (bookOdds[winner] - 1);
          bank += stake + payout;
        }
      }

      $("bank").textContent = "£" + bank.toFixed(2);
      $("races").textContent = String(races);
      const roi = totalStaked > 0 ? ((bank - 100) / totalStaked) * 100 : 0;
      $("roi").textContent = roi.toFixed(2) + "%";
      $("lastResult").textContent = `Last: simulated ${n.toLocaleString()} races`;
      clearMoney();
    }

    function resetGame(){
      bank = 100;
      races = 0;
      totalStaked = 0;

      trueProbs = randDirichlet5().map(p => 0.06 + 0.94*p);
      const s = trueProbs.reduce((a,b)=>a+b,0);
      trueProbs = trueProbs.map(x=>x/s);

      const ov = Number($("overround").value);
      bookOdds = computeBookOdds(ov);

      $("bank").textContent = "£" + bank.toFixed(2);
      $("races").textContent = "0";
      $("roi").textContent = "0.00%";
      $("lastResult").textContent = "Last: —";

      updateGameOddsUI();
      clearMoney();
      resetHorses();
    }

    function updateOverround(){
      const ov = Number($("overround").value);
      bookOdds = computeBookOdds(ov);
      updateGameOddsUI();
    }

    // Wire UI
    ["cBet","vBet","cIncome","vIncome","cDemo","vDemo","cResult","cSports","cGame","cOutro"]
      .map($)
      .forEach(addTilt);

    $("betSwitch").addEventListener("click", () => {
      betEnabled = !betEnabled;
      setBetUI();
      recalc();
    });
    $("betPerWeek").addEventListener("input", recalc);
    $("sportKey").addEventListener("change", recalc);
    $("income").addEventListener("input", recalc);
    $("age").addEventListener("input", recalc);
    $("sex").addEventListener("change", recalc);

    $("raceBtn").addEventListener("click", () => {
      const pick = Number($("pickHorse").value);
      const stake = Math.max(1, Number($("stake").value || 1));
      runRaceAnimated(pick, stake);
    });
    $("sim1kBtn").addEventListener("click", () => runSim(1000));
    $("sim10kBtn").addEventListener("click", () => runSim(10000));
    $("resetBankBtn").addEventListener("click", resetGame);
    $("overround").addEventListener("change", updateOverround);

    // Init
    updateHUD();
    setBetUI();
    recalc();
    resetGame();
  </script>
</body>
</html>
