<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Expected Gambling Loss — Story + Fullscreen Race</title>

  <style>
    :root{
      --bg:#000;
      --fg:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.58);
      --muted2:rgba(255,255,255,.40);
      --line:rgba(255,255,255,.10);
      --shadow: 0 24px 70px rgba(0,0,0,.75);
      --r:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font: 14px/1.45 var(--sans);
      letter-spacing:.12px;
      overflow-x:hidden;
    }

    /* subtle grain */
    body:before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.09;
      mix-blend-mode:overlay;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.22'/%3E%3C/svg%3E");
      z-index:0;
    }

    .scene{ position:relative; z-index:1; }
    .snap{
      height:100vh;
      overflow-y:auto;
      scroll-snap-type: y mandatory;
      scroll-behavior:smooth;
      position:relative;
      z-index:2;
    }
    section{
      min-height:100vh;
      scroll-snap-align:start;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 26px 18px;
      position:relative;
    }

    /* HUD */
    .hud{
      position:fixed;
      top:14px;
      left:50%;
      transform: translateX(-50%);
      z-index:6;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border:1px solid var(--line);
      border-radius: 999px;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(8px);
    }
    .hud .dot{ width:8px; height:8px; border-radius:999px; background:rgba(255,255,255,.8); }
    .hud .t{ font: 12px/1 var(--mono); color: var(--muted); }
    .hud .bar{
      width: 140px; height: 8px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius:999px;
      overflow:hidden;
    }
    .hud .bar i{
      display:block; height:100%;
      width: 0%;
      background: rgba(255,255,255,.82);
      transition: width .25s ease;
    }

    /* Prevent HUD overlap on fullscreen race page */
    body.inRace .raceTop{ margin-top: 62px; }
    body.inRace .hud{ left: 14px; transform:none; }
    @media (max-width: 700px){
      body.inRace .raceTop{ margin-top: 74px; }
    }

    /* Title */
    .hero{ width:min(980px, 100%); }
    .kicker{
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.22em;
      font-size:11px;
      margin-bottom:8px;
    }
    h1{
      margin:0;
      font-size: 32px;
      line-height: 1.05;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .sub{
      margin-top: 10px;
      color:var(--muted);
      max-width: 82ch;
      font-size: 13px;
    }
    .pill{
      display:inline-flex;
      gap:10px;
      align-items:center;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding: 8px 12px;
      border-radius: 999px;
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
      margin-top: 10px;
      font-family: var(--mono);
    }
    .pill .pDot{
      width:8px; height:8px; border-radius:999px;
      background: rgba(255,255,255,.78);
      box-shadow: 0 0 0 5px rgba(255,255,255,.08);
    }
    .scrollHint{
      position:absolute;
      left:50%;
      bottom: 22px;
      transform: translateX(-50%);
      color: var(--muted2);
      font-size: 12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
      pointer-events:none;
    }
    .scrollHint i{
      display:inline-block;
      width: 18px; height: 28px;
      border:1px solid rgba(255,255,255,.22);
      border-radius: 999px;
      position:relative;
    }
    .scrollHint i:after{
      content:"";
      position:absolute;
      left:50%;
      top:6px;
      width: 4px; height: 6px;
      background: rgba(255,255,255,.45);
      border-radius: 99px;
      transform: translateX(-50%);
      animation: wheel 1.2s ease-in-out infinite;
    }
    @keyframes wheel{
      0%{ transform: translateX(-50%) translateY(0); opacity:.55; }
      70%{ transform: translateX(-50%) translateY(10px); opacity:.15; }
      100%{ opacity:.55; }
    }

    /* Cards */
    .wrap{
      width:min(1040px, 100%);
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
      align-items:start;
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 900px){
      .grid2{ grid-template-columns: 1fr; }
    }
    .card{
      border:1px solid var(--line);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .inner{ padding: 16px; }
    .title{
      margin:0 0 12px;
      color:var(--muted);
      font-weight: 800;
      letter-spacing:.18em;
      text-transform:uppercase;
      font-size: 11px;
    }

    label{ color:var(--muted); font-size:12px; }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin: 10px 0;
    }
    input[type="range"]{ width:100%; }
    input[type="number"], select{
      width: 220px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.55);
      color:var(--fg);
      outline:none;
      font-family: var(--mono);
    }
    .toggle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(0,0,0,.35);
      margin-top: 12px;
    }
    .toggle .left{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .toggle .left b{
      font-size: 12px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color: var(--muted);
    }
    .toggle .left span{
      color: var(--muted2);
      font-size: 12px;
    }
    .switch{
      position:relative;
      width: 54px;
      height: 30px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border:1px solid var(--line);
      cursor:pointer;
      flex:0 0 auto;
    }
    .switch i{
      position:absolute;
      top: 3px; left: 3px;
      width: 24px; height: 24px;
      border-radius: 999px;
      background: rgba(255,255,255,.92);
      transition: transform .18s ease;
      will-change: transform;
    }
    .switch.on i{ transform: translateX(24px); }

    .note{
      color:var(--muted2);
      font-size: 12px;
      margin-top: 12px;
      line-height:1.55;
    }

    /* Result stats */
    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }
    @media (max-width: 600px){
      .split{ grid-template-columns: 1fr; }
    }
    .stat{
      border:1px solid var(--line);
      background: rgba(0,0,0,.45);
      border-radius: 16px;
      padding: 12px;
    }
    .stat .k{ color:var(--muted); font-size: 12px; }
    .stat .v{ font-size: 28px; font-weight: 900; margin-top: 2px; letter-spacing:.2px; font-family: var(--mono); }
    .stat .s{ color:var(--muted2); font-size: 12px; margin-top: 4px; font-family: var(--mono); }
    .bar{
      height: 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      overflow:hidden;
      margin-top: 10px;
    }
    .bar > i{
      display:block;
      height:100%;
      width:0%;
      background: rgba(255,255,255,.80);
      transition: width .35s ease;
    }

    /* Leak map */
    .viz{
      border:1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      background: rgba(0,0,0,.35);
      padding: 12px;
      margin-top: 12px;
      overflow:hidden;
    }

    /* ---------- FULLSCREEN HORSE GAME ---------- */
    section.fullscreen{
      padding:0;
      align-items:stretch;
      justify-content:stretch;
    }
    .raceShell{
      width:100%;
      height:100vh;
      position:relative;
      display:flex;
      flex-direction:column;
    }
    .raceTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 14px 18px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      z-index:3;
      flex-wrap:wrap;
    }
    .raceTop .brand{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 0;
    }
    .raceTop .brand b{
      font-family: var(--mono);
      letter-spacing:.10em;
      text-transform:uppercase;
      font-size: 12px;
      color: rgba(255,255,255,.78);
    }
    .raceTop .brand span{
      font-size: 12px;
      color: rgba(255,255,255,.45);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 60ch;
    }
    .raceControls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.90);
      border-radius: 999px;
      padding: 10px 12px;
      cursor:pointer;
      font-family: var(--mono);
      font-size: 12px;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.08); }
    .raceTop select, .raceTop input{
      width:auto;
      min-width: 120px;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.55);
      color: rgba(255,255,255,.90);
      font-family: var(--mono);
      outline:none;
    }

    .raceBody{
      flex:1;
      position:relative;
      overflow:hidden;
      background:
        radial-gradient(120% 90% at 50% 15%, rgba(255,255,255,.05), rgba(0,0,0,0) 55%),
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.0));
    }

    /* Decorative scene background (grayscale) */
    .sceneBg{
      position:absolute;
      inset:0;
      z-index:0;
      pointer-events:none;
      opacity:.95;
    }
    .sceneBg svg{ width:100%; height:100%; display:block; }

    /* spectators */
    .stands{
      position:absolute;
      inset:0 0 auto 0;
      height: 30vh;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,0)),
        repeating-linear-gradient(90deg, rgba(255,255,255,.04) 0 2px, rgba(0,0,0,0) 2px 10px);
      overflow:hidden;
      z-index:1;
    }
    .crowd{
      position:absolute;
      left:0; right:0; bottom: 14px;
      height: 60%;
      opacity:.75;
    }
    .crowd i{
      position:absolute;
      bottom:0;
      width: 6px; height: 10px;
      border-radius: 999px 999px 4px 4px;
      background: rgba(255,255,255,.20);
      animation: crowdBob 620ms ease-in-out infinite;
    }
    @keyframes crowdBob{
      0%{ transform: translateY(0); opacity:.50; }
      50%{ transform: translateY(-3px); opacity:.75; }
      100%{ transform: translateY(0); opacity:.50; }
    }

    .track{
      position:absolute;
      left:0; right:0;
      bottom:0;
      height: 70vh;
      border-top:1px solid rgba(255,255,255,.10);
      background:
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)),
        radial-gradient(120% 90% at 50% 80%, rgba(0,0,0,.55), rgba(0,0,0,0) 60%);
      z-index:1;
      overflow:hidden;
    }
    .lanes{
      position:absolute;
      left:0; right:0; top:0; bottom:0;
    }
    .lane{
      position:absolute; left:0; right:0;
      height: 20%;
      border-top:1px solid rgba(255,255,255,.08);
    }
    .lane:nth-child(1){ top:0%; }
    .lane:nth-child(2){ top:20%; }
    .lane:nth-child(3){ top:40%; }
    .lane:nth-child(4){ top:60%; }
    .lane:nth-child(5){ top:80%; }

    .finish{
      position:absolute;
      top:0; bottom:0;
      right: 220px;
      width: 3px;
      background: rgba(255,255,255,.40);
      box-shadow: 0 0 0 6px rgba(255,255,255,.06);
    }
    .finish:after{
      content:"";
      position:absolute;
      right:-12px; top:0; bottom:0;
      width: 24px;
      background: repeating-linear-gradient(
        180deg,
        rgba(255,255,255,.22) 0 12px,
        rgba(0,0,0,0) 12px 24px
      );
      opacity:.40;
    }

    /* hyper mode: fast multi-run */
    .track.hyper:before{
      content:"";
      position:absolute;
      inset:0;
      background: repeating-linear-gradient(90deg, rgba(255,255,255,.04) 0 14px, rgba(0,0,0,0) 14px 38px);
      opacity:.55;
      animation: hyperStreak 260ms linear infinite;
      pointer-events:none;
    }
    @keyframes hyperStreak{
      0%{ transform: translateX(0); }
      100%{ transform: translateX(-38px); }
    }
    .track.hyper .horse{ filter: blur(.35px); }
    .track.hyper .horse.run .body{ animation-duration: 90ms; }
    .track.hyper .horse.run .head{ animation-duration: 90ms; }
    .track.hyper .horse.run .legA{ animation-duration: 70ms; }
    .track.hyper .horse.run .legB{ animation-duration: 70ms; }
    .track.hyper .horse.run .tail{ animation-duration: 100ms; }
    .track.hyper .horse.run + .dust i{ animation-duration: 220ms; }

    /* bookie booth */
    .bookieBooth{
      position:absolute;
      top: 14px;
      right: 14px;
      width: 190px;
      height: calc(100% - 28px);
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.52);
      backdrop-filter: blur(8px);
      overflow:hidden;
      z-index:2;
    }
    .bookieBooth .head{
      padding: 12px 12px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .bookieBooth .head b{
      font-family: var(--mono);
      letter-spacing:.12em;
      text-transform:uppercase;
      font-size: 11px;
      color: rgba(255,255,255,.75);
    }
    .bookieBooth .head span{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(255,255,255,.55);
    }
    .bookieArt{
      position:absolute;
      left:0; right:0; bottom:0;
      height: 62%;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding-bottom: 10px;
    }
    .bookieArt svg{ width: 220px; height: 320px; opacity:.95; }
    .bookieBooth.pay .arm{ animation: armPay 420ms ease-in-out 1; transform-origin: 130px 140px; }
    .bookieBooth.take .arm{ animation: armTake 420ms ease-in-out 1; transform-origin: 130px 140px; }
    .bookieBooth.pay .cash{ animation: cashPulse 420ms ease-in-out 1; }
    @keyframes armPay{
      0%{ transform: rotate(0deg) translateX(0); }
      50%{ transform: rotate(-14deg) translateX(-6px); }
      100%{ transform: rotate(0deg) translateX(0); }
    }
    @keyframes armTake{
      0%{ transform: rotate(0deg) translateX(0); }
      50%{ transform: rotate(12deg) translateX(4px); }
      100%{ transform: rotate(0deg) translateX(0); }
    }
    @keyframes cashPulse{
      0%{ opacity:.55; transform: translateY(0); }
      50%{ opacity:1; transform: translateY(-2px); }
      100%{ opacity:.75; transform: translateY(0); }
    }

    /* horses */
    .horse{
      position:absolute;
      left: 18px;
      width: 240px;
      height: 78px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      z-index:1;
      will-change: transform;
      box-shadow: 0 16px 60px rgba(0,0,0,.55);
    }
    .horse .tag{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .horse .tag b{
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color: rgba(255,255,255,.85);
    }
    .horse .tag span{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(255,255,255,.55);
    }
    .horse .odds{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,.80);
    }
    .horse svg{
      width: 100px;
      height: 52px;
      overflow: visible;
    }

    /* richer gallop */
    .horse.run .body{ animation: bob 180ms infinite ease-in-out; transform-origin: 20px 20px; }
    .horse.run .head{ animation: head 180ms infinite ease-in-out; transform-origin: 56px 18px; }
    .horse.run .legA{ animation: legA 140ms infinite ease-in-out; transform-origin: 26px 38px; }
    .horse.run .legB{ animation: legB 140ms infinite ease-in-out; transform-origin: 26px 38px; }
    .horse.run .tail{ animation: tail 200ms infinite ease-in-out; transform-origin: 10px 22px; }
    .horse.run .mane{ animation: mane 160ms infinite ease-in-out; transform-origin: 46px 12px; }

    @keyframes bob{ 0%{ transform: translateY(0);} 50%{ transform: translateY(2px);} 100%{ transform: translateY(0);} }
    @keyframes head{ 0%{ transform: rotate(2deg);} 50%{ transform: rotate(-2deg);} 100%{ transform: rotate(2deg);} }
    @keyframes legA{ 0%{ transform: rotate(18deg);} 50%{ transform: rotate(-18deg);} 100%{ transform: rotate(18deg);} }
    @keyframes legB{ 0%{ transform: rotate(-18deg);} 50%{ transform: rotate(18deg);} 100%{ transform: rotate(-18deg);} }
    @keyframes tail{ 0%{ transform: rotate(10deg);} 50%{ transform: rotate(-10deg);} 100%{ transform: rotate(10deg);} }
    @keyframes mane{ 0%{ transform: translateY(0);} 50%{ transform: translateY(1px);} 100%{ transform: translateY(0);} }

    /* dust */
    .dust{
      position:absolute;
      width: 200px; height: 90px;
      left: 0;
      pointer-events:none;
      opacity:0;
      z-index:1;
    }
    .dust i{
      position:absolute;
      bottom: 12px;
      width: 9px; height: 9px;
      border-radius:999px;
      background: rgba(255,255,255,.12);
      animation: dust 420ms infinite ease-out;
    }
    @keyframes dust{
      0%{ transform: translateX(0) translateY(0) scale(0.9); opacity:.35; }
      100%{ transform: translateX(-36px) translateY(-14px) scale(1.3); opacity:0; }
    }
    .horse.run + .dust{ opacity:1; }

    /* money particles */
    .money{
      position:absolute;
      width: 14px;
      height: 8px;
      border-radius: 3px;
      background: rgba(255,255,255,.86);
      box-shadow: 0 0 0 1px rgba(255,255,255,.18);
      pointer-events:none;
      opacity:0;
      will-change: transform, opacity;
      z-index:3;
    }

    /* confetti on win */
    .confetti{
      position:absolute;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index:4;
      opacity:0;
      transition: opacity 160ms ease;
    }
    .confetti.on{ opacity:1; }
    .confetti i{
      position:absolute;
      top:-10px;
      width: 10px; height: 6px;
      border-radius: 2px;
      opacity:.9;
      animation: confettiFall 900ms ease-in forwards;
    }
    @keyframes confettiFall{
      0%{ transform: translateY(0) rotate(0deg); opacity:0.0; }
      10%{ opacity:.95; }
      100%{ transform: translateY(85vh) rotate(240deg); opacity:0; }
    }

    /* bottom stats strip */
    .raceBottom{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 12px 18px;
      border-top:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      z-index:3;
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,.70);
      flex-wrap:wrap;
    }
    .raceBottom strong{ color: rgba(255,255,255,.92); }

    /* colored horses only */
    .c1{ --hc:#ff4d4d; }
    .c2{ --hc:#4dd2ff; }
    .c3{ --hc:#ffe14d; }
    .c4{ --hc:#a84dff; }
    .c5{ --hc:#4dff88; }

    .horse .sil{ fill: color-mix(in srgb, var(--hc) 78%, white 22%); }
    .horse .sil2{ fill: color-mix(in srgb, var(--hc) 55%, black 45%); opacity:.9; }
    .horse .stroke{ stroke: rgba(255,255,255,.24); }

    /* ---- Sound control ---- */
    .soundBtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.90);
      cursor:pointer;
      font-family: var(--mono);
      font-size: 12px;
      user-select:none;
    }
    .soundBtn:hover{ background: rgba(255,255,255,.08); }
    .soundDot{
      width:8px; height:8px; border-radius:999px;
      background: rgba(255,255,255,.45);
      box-shadow: 0 0 0 5px rgba(255,255,255,.08);
    }
    .soundBtn.on .soundDot{ background: rgba(255,255,255,.90); }

    /* respect reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{ animation-duration: 1ms !important; animation-iteration-count: 1 !important; transition-duration: 1ms !important; scroll-behavior:auto !important; }
      .track.hyper:before{ display:none !important; }
    }
  </style>
</head>

<body>
  <div class="hud" aria-hidden="true">
    <span class="dot"></span>
    <span class="t" id="hudText">PAGE 1 / 4</span>
    <span class="bar"><i id="hudBar"></i></span>
  </div>

  <div class="scene">
    <div class="snap" id="snap">

      <!-- PAGE 1: Title -->
      <section data-page="1">
        <div class="hero">
          <div class="kicker">Minimal • black & white • scroll</div>
          <h1>Expected gambling loss.<br/>Told like a story.</h1>
          <div class="sub">
            If you enter <span style="font-family:var(--mono)">stake/week</span>, the £ estimate is driven by maths (edge × turnover),
            not “being lucky” because of age/sex.
          </div>
          <div class="pill"><span class="pDot"></span> ASSUMPTION: gambles this year</div>
        </div>
        <div class="scrollHint"><i></i> scroll</div>
      </section>

      <!-- PAGE 2: Inputs -->
      <section data-page="2">
        <div class="wrap">
          <div class="card">
            <div class="inner">
              <div class="title">Inputs</div>

              <div class="toggle">
                <div class="left">
                  <b>Use stake/week</b>
                  <span>When ON, stake/week drives the £ result.</span>
                </div>
                <div class="switch" id="betSwitch" role="button" aria-label="Toggle stake/week"><i></i></div>
              </div>

              <div class="grid2">
                <div>
                  <div class="row" id="betRow" style="display:none; margin-top:12px;">
                    <label for="betPerWeek">Stake/week (£)</label>
                    <input id="betPerWeek" type="number" min="0" step="5" placeholder="e.g. 50" />
                  </div>

                  <div class="row" style="margin-top:12px;">
                    <label for="sportKey">Bet type</label>
                    <select id="sportKey">
                      <option value="soccer">Soccer-like</option>
                      <option value="tennis">Tennis-like</option>
                      <option value="racing">Horse-racing-like</option>
                      <option value="greyhound">Greyhound-like</option>
                    </select>
                  </div>

                  <div class="row">
                    <label for="income">Disposable income (£/year)</label>
                    <input id="income" type="number" min="0" step="50" value="20000" />
                  </div>
                </div>

                <div>
                  <div class="row">
                    <label for="age">Age</label>
                    <div style="font-family:var(--mono)" id="ageVal">30</div>
                  </div>
                  <input id="age" type="range" min="18" max="90" value="30" />

                  <div class="row" style="margin-top:12px;">
                    <label for="sex">Sex</label>
                    <select id="sex">
                      <option value="male">male</option>
                      <option value="female">female</option>
                    </select>
                  </div>

                  <div class="note" id="inputNote">
                    Tip: if stake/week is OFF, the model uses a demographic fallback. If it’s ON, stake/week dominates the £ result.
                  </div>
                </div>
              </div>

              <div class="note" style="margin-top:14px;">
                Scroll to see the result and what it means.
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- PAGE 3: Final + explanation underneath -->
      <section data-page="3">
        <div class="wrap">
          <div class="card">
            <div class="inner">
              <div class="title">Final — What leaks out?</div>

              <div class="split">
                <div class="stat">
                  <div class="k">Expected annual net loss</div>
                  <div class="v" id="expLoss">—</div>
                  <div class="s" id="band">—</div>
                  <div class="bar"><i id="posBar"></i></div>
                </div>

                <div class="stat">
                  <div class="k">Loss as % of income</div>
                  <div class="v" id="pctIncome">—</div>
                  <div class="s" id="modeLine">—</div>
                  <div class="bar"><i id="pctBar"></i></div>
                </div>
              </div>

              <div class="note" style="font-family:var(--mono)" id="capLine">CAPS: —</div>
              <div class="note" id="bananaLine">You could buy: —</div>

              <div class="viz">
                <svg viewBox="0 0 520 220" width="100%" height="220" aria-label="Leak map">
                  <text x="18" y="30" fill="rgba(255,255,255,.55)" font-size="12" font-family="ui-monospace, monospace">WHERE YOU’RE MOST LIKELY TO LEAK MONEY</text>
                  <g id="sportPipes" transform="translate(18,52)"></g>
                  <text id="riskExplain" x="18" y="206" fill="rgba(255,255,255,.55)" font-size="12" font-family="ui-monospace, monospace">—</text>
                </svg>
              </div>

              <div class="note" style="font-family:var(--mono)" id="topRisk">—</div>

              <div class="note" id="explainBlock">
                <b style="color:rgba(255,255,255,.78); font-family:var(--mono); letter-spacing:.10em; text-transform:uppercase; font-size:11px;">How this works</b><br/><br/>
                <span style="color:rgba(255,255,255,.62)">
                  • If <span style="font-family:var(--mono)">stake/week</span> is ON and > 0, expected loss ≈ <span style="font-family:var(--mono)">stake/week × 52 × lossRate</span>.<br/>
                  • If stake/week is OFF, the model uses a demographic fallback (coarse risk-banding), so age/sex can change the estimate.<br/>
                  • Disposable income applies guardrails so tiny incomes don’t produce absurd losses.
                </span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- PAGE 4: Fullscreen horse game -->
      <section class="fullscreen" data-page="4">
        <div class="raceShell">
          <div class="raceTop">
            <div class="brand">
              <b>Horse racing simulator</b>
              <span>Over enough races, the book wins (overround & negative EV).</span>
            </div>

            <div class="raceControls">
              <button class="soundBtn" id="soundBtn" type="button" title="Toggle sound">
                <span class="soundDot"></span><span id="soundLabel">Sound OFF</span>
              </button>

              <select id="pickHorse">
                <option value="0">Pick: Horse 1</option>
                <option value="1">Pick: Horse 2</option>
                <option value="2">Pick: Horse 3</option>
                <option value="3">Pick: Horse 4</option>
                <option value="4">Pick: Horse 5</option>
              </select>

              <input id="stake" type="number" min="1" step="1" value="5" />

              <select id="overround">
                <option value="1.05">Overround 105%</option>
                <option value="1.12" selected>Overround 112%</option>
                <option value="1.20">Overround 120%</option>
              </select>

              <button class="btn" id="raceBtn" type="button">Run 1</button>

              <input id="raceCount" type="number" min="1" step="1" value="250" title="Number of races" />
              <button class="btn" id="runCustomBtn" type="button">Run N</button>

              <button class="btn" id="resetBankBtn" type="button">Reset</button>
            </div>
          </div>

          <div class="raceBody" id="raceBody">
            <!-- Decorative scene -->
            <div class="sceneBg" aria-hidden="true">
              <svg viewBox="0 0 1200 500" preserveAspectRatio="xMidYMid slice">
                <rect x="0" y="0" width="1200" height="260" fill="rgba(255,255,255,.06)"/>
                <g opacity=".45" fill="rgba(255,255,255,.22)">
                  <ellipse cx="160" cy="90" rx="60" ry="22"/><ellipse cx="210" cy="90" rx="40" ry="18"/><ellipse cx="120" cy="95" rx="44" ry="18"/>
                  <ellipse cx="860" cy="70" rx="70" ry="24"/><ellipse cx="920" cy="72" rx="46" ry="18"/><ellipse cx="810" cy="74" rx="44" ry="18"/>
                </g>
                <path d="M0,240 C240,170 380,210 520,200 C700,188 820,140 1200,205 L1200,320 L0,320 Z"
                  fill="rgba(255,255,255,.05)"/>
                <path d="M0,255 C260,210 420,250 580,238 C760,224 900,190 1200,240 L1200,340 L0,340 Z"
                  fill="rgba(255,255,255,.035)"/>
                <g opacity=".9">
                  <rect x="90" y="130" width="250" height="110" rx="14" fill="rgba(255,255,255,.05)" stroke="rgba(255,255,255,.10)"/>
                  <rect x="870" y="130" width="250" height="110" rx="14" fill="rgba(255,255,255,.05)" stroke="rgba(255,255,255,.10)"/>
                  <g fill="rgba(255,255,255,.12)">
                    <!-- seats dots -->
                    <circle cx="120" cy="175" r="5"/><circle cx="142" cy="175" r="5"/><circle cx="164" cy="175" r="5"/><circle cx="186" cy="175" r="5"/><circle cx="208" cy="175" r="5"/><circle cx="230" cy="175" r="5"/><circle cx="252" cy="175" r="5"/><circle cx="274" cy="175" r="5"/><circle cx="296" cy="175" r="5"/><circle cx="318" cy="175" r="5"/>
                    <circle cx="120" cy="205" r="5"/><circle cx="142" cy="205" r="5"/><circle cx="164" cy="205" r="5"/><circle cx="186" cy="205" r="5"/><circle cx="208" cy="205" r="5"/><circle cx="230" cy="205" r="5"/><circle cx="252" cy="205" r="5"/><circle cx="274" cy="205" r="5"/><circle cx="296" cy="205" r="5"/><circle cx="318" cy="205" r="5"/>
                    <circle cx="900" cy="175" r="5"/><circle cx="922" cy="175" r="5"/><circle cx="944" cy="175" r="5"/><circle cx="966" cy="175" r="5"/><circle cx="988" cy="175" r="5"/><circle cx="1010" cy="175" r="5"/><circle cx="1032" cy="175" r="5"/><circle cx="1054" cy="175" r="5"/><circle cx="1076" cy="175" r="5"/><circle cx="1098" cy="175" r="5"/>
                    <circle cx="900" cy="205" r="5"/><circle cx="922" cy="205" r="5"/><circle cx="944" cy="205" r="5"/><circle cx="966" cy="205" r="5"/><circle cx="988" cy="205" r="5"/><circle cx="1010" cy="205" r="5"/><circle cx="1032" cy="205" r="5"/><circle cx="1054" cy="205" r="5"/><circle cx="1076" cy="205" r="5"/><circle cx="1098" cy="205" r="5"/>
                  </g>
                  <g stroke="rgba(255,255,255,.12)">
                    <line x1="120" y1="120" x2="120" y2="145"/><line x1="1040" y1="120" x2="1040" y2="145"/>
                  </g>
                  <g fill="rgba(255,255,255,.18)">
                    <path d="M120 122 L150 130 L120 138 Z"/><path d="M1040 122 L1070 130 L1040 138 Z"/>
                  </g>
                </g>
                <path d="M360 240 C450 225 520 250 600 240 C700 230 760 255 840 240"
                  stroke="rgba(255,255,255,.12)" stroke-width="3" fill="none"/>
                <g opacity=".55" fill="rgba(255,255,255,.16)">
                  <path d="M380 242 L396 262 L412 242 Z"/><path d="M418 242 L434 262 L450 242 Z"/><path d="M456 242 L472 262 L488 242 Z"/>
                  <path d="M494 242 L510 262 L526 242 Z"/><path d="M532 242 L548 262 L564 242 Z"/><path d="M570 242 L586 262 L602 242 Z"/>
                  <path d="M608 242 L624 262 L640 242 Z"/><path d="M646 242 L662 262 L678 242 Z"/><path d="M684 242 L700 262 L716 242 Z"/>
                  <path d="M722 242 L738 262 L754 242 Z"/><path d="M760 242 L776 262 L792 242 Z"/><path d="M798 242 L814 262 L830 242 Z"/>
                </g>
              </svg>
            </div>

            <div class="stands">
              <div class="crowd" id="crowd"></div>
            </div>

            <div class="track" id="track">
              <div class="lanes">
                <div class="lane"></div><div class="lane"></div><div class="lane"></div><div class="lane"></div><div class="lane"></div>
              </div>

              <div class="finish"></div>

              <div class="bookieBooth" id="bookie">
                <div class="head">
                  <b>BOOKIE</b>
                  <span id="oddsBanner">Overround: —</span>
                </div>
                <div class="bookieArt">
                  <svg viewBox="0 0 260 340" aria-label="Bookie">
                    <rect x="35" y="60" width="190" height="240" rx="22" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.12)"/>
                    <rect x="35" y="230" width="190" height="70" rx="18" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.12)"/>
                    <text x="58" y="92" fill="rgba(255,255,255,.55)" font-size="12" font-family="ui-monospace, monospace">ODDS INSIDE</text>

                    <circle cx="140" cy="140" r="22" fill="rgba(255,255,255,.82)"/>
                    <rect x="116" y="164" width="48" height="56" rx="18" fill="rgba(255,255,255,.18)"/>
                    <rect x="106" y="178" width="26" height="12" rx="6" fill="rgba(255,255,255,.14)"/>
                    <rect x="148" y="178" width="26" height="12" rx="6" fill="rgba(255,255,255,.14)"/>

                    <rect x="118" y="112" width="44" height="14" rx="6" fill="rgba(255,255,255,.22)"/>
                    <rect x="112" y="124" width="56" height="8" rx="4" fill="rgba(255,255,255,.16)"/>

                    <rect class="arm" x="164" y="188" width="62" height="14" rx="7" fill="rgba(255,255,255,.28)"/>

                    <rect x="86" y="250" width="120" height="26" rx="12" fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.10)"/>
                    <g class="cash">
                      <rect x="150" y="246" width="42" height="14" rx="4" fill="rgba(255,255,255,.18)"/>
                      <rect x="146" y="256" width="50" height="14" rx="4" fill="rgba(255,255,255,.24)"/>
                      <rect x="142" y="266" width="58" height="14" rx="4" fill="rgba(255,255,255,.32)"/>
                    </g>

                    <circle cx="132" cy="138" r="3" fill="rgba(0,0,0,.72)"/>
                    <circle cx="148" cy="138" r="3" fill="rgba(0,0,0,.72)"/>
                  </svg>
                </div>
              </div>

              <div class="confetti" id="confetti"></div>

              <!-- Horses -->
              <div class="horse c1" id="h0" style="top: 4%;">
                <div class="tag"><b>H1</b><span id="o0">—</span></div>
                <svg viewBox="0 0 90 48" aria-hidden="true">
                  <g class="body">
                    <ellipse class="sil" cx="40" cy="26" rx="18" ry="12"></ellipse>
                    <g class="head">
                      <ellipse class="sil" cx="62" cy="20" rx="9" ry="7"></ellipse>
                      <circle class="sil2" cx="66" cy="18" r="2.2"></circle>
                    </g>
                    <g class="mane">
                      <path d="M54 14 C48 16, 50 10, 44 12" class="stroke" stroke-width="2" fill="none" stroke-linecap="round"/>
                    </g>
                    <g class="tail">
                      <path d="M22 26 C14 20, 14 34, 22 30" class="stroke" stroke-width="3" fill="none" stroke-linecap="round"/>
                    </g>
                    <g class="legA">
                      <path d="M34 36 L28 46" class="stroke" stroke-width="3" fill="none" stroke-linecap="round"/>
                      <path d="M46 36 L40 46" class="stroke" stroke-width="3" fill="none" stroke-linecap="round"/>
                    </g>
                    <g class="legB">
                      <path d="M38 36 L34 46" class="stroke" stroke-width="3" fill="none" stroke-linecap="round" opacity=".55"/>
                      <path d="M50 36 L46 46" class="stroke" stroke-width="3" fill="none" stroke-linecap="round" opacity=".55"/>
                    </g>
                  </g>
                </svg>
              </div>
              <div class="dust" style="top: 4%;"><i style="left:40px"></i><i style="left:72px; animation-delay:80ms"></i><i style="left:102px; animation-delay:160ms"></i></div>

              <div class="horse c2" id="h1" style="top: 24%;">
                <div class="tag"><b>H2</b><span id="o1">—</span></div>
                <svg viewBox="0 0 90 48" aria-hidden="true">
                  <g class="body">
                    <ellipse class="sil" cx="40" cy="26" rx="18" ry="12"></ellipse>
                    <g class="head">
                      <ellipse class="sil" cx="62" cy="20" rx="9" ry="7"></ellipse>
                      <circle class="sil2" cx="66" cy="18" r="2.2"></circle>
                    </g>
                    <g class="mane">
                      <path d="M54 14 C48 16, 50 10, 44 12" class="stroke" stroke-width="2" fill="none" stroke-linecap="round"/>
                    </g>
                    <g class="tail">
                      <path d="M22 26 C14 20, 14 34, 22 30" class="stroke" stroke-width="3" fill="none" stroke-linecap="round"/>
                    </g>
                    <g class="legA">
                      <path d="M34 36 L28 46" class="stroke" stroke-width="3" fill="none" stroke-linecap="round"/>
                      <path d="M46 36 L40 46" class="stroke" stroke-width="3" fill="none" stroke-linecap="round"/>
                    </g>
                    <g class="legB">
                      <path d="M38 36 L34 46" class="stroke" stroke-width="3" fill="none" stroke-linecap="round" opacity=".55"/>
                      <path d="M50 36 L46 46" class="stroke" stroke-width="3" fill="none" stroke-linecap="round" opacity=".55"/>
                    </g>
                  </g>
                </svg>
              </div>
              <div class="dust" style="top: 24%;"><i style="left:40px"></i><i style="left:72px; animation-delay:80ms"></i><i style="left:102px; animation-delay:160ms"></i></div>

              <div class="horse c3" id="h2" style="top: 44%;">
                <div class="tag"><b>H3</b><span id="o2">—</span></div>
                <svg viewBox="0 0 90 48" aria-hidden="true">
                  <g class="body">
                    <ellipse class="sil" cx="40" cy="26" rx="18" ry="12"></ellipse>
                    <g class="head">
                      <ellipse class="sil" cx="62" cy="20" rx="9" ry="7"></ellipse>
                      <circle class="sil2" cx="66" cy="18" r="2.2"></circle>
                    </g>
                    <g class="mane">
                      <path d="M54 14 C48 16, 50 10, 44 12" class="stroke" stroke-width="2" fill="none" stroke-linecap="round"/>
                    </g>
                    <g class="tail">
                      <path d="M22 26 C14 20, 14 34, 22 30" class="stroke" stroke-width="3" fill="none" stroke-linecap="round"/>
                    </g>
                    <g class="legA">
                      <path d="M34 36 L28 46" class="stroke" stroke-width="3" fill="none" stroke-linecap="round"/>
                      <path d="M46 36 L40 46" class="stroke" stroke-width="3" fill="none" stroke-linecap="round"/>
                    </g>
                    <g class="legB">
                      <path d="M38 36 L34 46" class="stroke" stroke-width="3" fill="none" stroke-linecap="round" opacity=".55"/>
                      <path d="M50 36 L46 46" class="stroke" stroke-width="3" fill="none" stroke-linecap="round" opacity=".55"/>
                    </g>
                  </g>
                </svg>
              </div>
              <div class="dust" style="top: 44%;"><i style="left:40px"></i><i style="left:72px; animation-delay:80ms"></i><i style="left:102px; animation-delay:160ms"></i></div>

              <div class="horse c4" id="h3" style="top: 64%;">
                <div class="tag"><b>H4</b><span id="o3">—</span></div>
                <svg viewBox="0 0 90 48" aria-hidden="true">
                  <g class="body">
                    <ellipse class="sil" cx="40" cy="26" rx="18" ry="12"></ellipse>
                    <g class="head">
                      <ellipse class="sil" cx="62" cy="20" rx="9" ry="7"></ellipse>
                      <circle class="sil2" cx="66" cy="18" r="2.2"></circle>
                    </g>
                    <g class="mane">
                      <path d="M54 14 C48 16, 50 10, 44 12" class="stroke" stroke-width="2" fill="none" stroke-linecap="round"/>
                    </g>
                    <g class="tail">
                      <path d="M22 26 C14 20, 14 34, 22 30" class="stroke" stroke-width="3" fill="none" stroke-linecap="round"/>
                    </g>
                    <g class="legA">
                      <path d="M34 36 L28 46" class="stroke" stroke-width="3" fill="none" stroke-linecap="round"/>
                      <path d="M46 36 L40 46" class="stroke" stroke-width="3" fill="none" stroke-linecap="round"/>
                    </g>
                    <g class="legB">
                      <path d="M38 36 L34 46" class="stroke" stroke-width="3" fill="none" stroke-linecap="round" opacity=".55"/>
                      <path d="M50 36 L46 46" class="stroke" stroke-width="3" fill="none" stroke-linecap="round" opacity=".55"/>
                    </g>
                  </g>
                </svg>
              </div>
              <div class="dust" style="top: 64%;"><i style="left:40px"></i><i style="left:72px; animation-delay:80ms"></i><i style="left:102px; animation-delay:160ms"></i></div>

              <div class="horse c5" id="h4" style="top: 84%;">
                <div class="tag"><b>H5</b><span id="o4">—</span></div>
                <svg viewBox="0 0 90 48" aria-hidden="true">
                  <g class="body">
                    <ellipse class="sil" cx="40" cy="26" rx="18" ry="12"></ellipse>
                    <g class="head">
                      <ellipse class="sil" cx="62" cy="20" rx="9" ry="7"></ellipse>
                      <circle class="sil2" cx="66" cy="18" r="2.2"></circle>
                    </g>
                    <g class="mane">
                      <path d="M54 14 C48 16, 50 10, 44 12" class="stroke" stroke-width="2" fill="none" stroke-linecap="round"/>
                    </g>
                    <g class="tail">
                      <path d="M22 26 C14 20, 14 34, 22 30" class="stroke" stroke-width="3" fill="none" stroke-linecap="round"/>
                    </g>
                    <g class="legA">
                      <path d="M34 36 L28 46" class="stroke" stroke-width="3" fill="none" stroke-linecap="round"/>
                      <path d="M46 36 L40 46" class="stroke" stroke-width="3" fill="none" stroke-linecap="round"/>
                    </g>
                    <g class="legB">
                      <path d="M38 36 L34 46" class="stroke" stroke-width="3" fill="none" stroke-linecap="round" opacity=".55"/>
                      <path d="M50 36 L46 46" class="stroke" stroke-width="3" fill="none" stroke-linecap="round" opacity=".55"/>
                    </g>
                  </g>
                </svg>
              </div>
              <div class="dust" style="top: 84%;"><i style="left:40px"></i><i style="left:72px; animation-delay:80ms"></i><i style="left:102px; animation-delay:160ms"></i></div>

            </div>
          </div>

          <div class="raceBottom">
            <div>Bankroll: <strong id="bank">£100.00</strong></div>
            <div>Races: <strong id="races">0</strong></div>
            <div>ROI: <strong id="roi">0.00%</strong></div>
            <div id="lastResult">Last: —</div>
          </div>
        </div>
      </section>

    </div>
  </div>

  <script>
    // ---------------- Banana joke ----------------
    const BANANA_PRICE_GBP = 0.25;
    function bananasFromLoss(loss){
      const n = Math.max(0, Math.round(loss / BANANA_PRICE_GBP));
      return n.toLocaleString();
    }

    // ---------------- Fallback demographic anchors ----------------
    const LOSS_PGSI0   = 196.95;
    const LOSS_PGSI1_4 = 955.21;
    const LOSS_PGSI5P  = 2506.91;
    const AT_RISK_LOSS_PCT_INCOME   = 0.023;
    const HIGH_RISK_LOSS_PCT_INCOME = 0.059;

    const PGSI_BY_SEX = {
      male:   { low_1_2: 0.165, mod_3_7: 0.066, prob_8p: 0.060 },
      female: { low_1_2: 0.130, mod_3_7: 0.039, prob_8p: 0.028 },
    };
    const YOUNG_MULT = 2.27;
    const OLD_MULT   = 0.11;

    // ---------------- Leak presets ----------------
    const SPORT_RISK = {
      soccer:    { name:"Soccer",    rate:0.078, note:"~7.8% leak proxy" },
      tennis:    { name:"Tennis",    rate:0.075, note:"~7.5% leak proxy" },
      racing:    { name:"Racing",    rate:0.120, note:"fatter books vary" },
      greyhound: { name:"Greyhound", rate:0.260, note:"very fat books" },
    };
    const SPORT_ORDER = ["greyhound","racing","soccer","tennis"];

    const $ = (id) => document.getElementById(id);
    const clamp = (x, lo, hi) => Math.max(lo, Math.min(hi, x));
    const lerp = (a,b,t) => a + (b-a)*t;

    // ---------------- HUD ----------------
    const snap = $("snap");
    const pages = Array.from(document.querySelectorAll("section[data-page]"));
    const hudText = $("hudText");
    const hudBar  = $("hudBar");

    function updateHUD(){
      const st = snap.scrollTop;
      const max = Math.max(1, snap.scrollHeight - snap.clientHeight);
      hudBar.style.width = ((st / max) * 100).toFixed(1) + "%";

      let best = 0, bestDist = Infinity;
      for (let i=0;i<pages.length;i++){
        const d = Math.abs(pages[i].offsetTop - st);
        if (d < bestDist){ bestDist = d; best = i; }
      }
      hudText.textContent = `PAGE ${best+1} / ${pages.length}`;
    }
    snap.addEventListener("scroll", updateHUD, { passive:true });

    // Mark when in race to avoid HUD overlap
    (function(){
      const raceSection = document.querySelector('section[data-page="4"]');
      if (!raceSection) return;
      const io = new IntersectionObserver((entries)=>{
        const e = entries[0];
        document.body.classList.toggle("inRace", e.isIntersecting && e.intersectionRatio > 0.55);
      }, { threshold:[0,0.55,1] });
      io.observe(raceSection);
    })();

    // ---------------- Model ----------------
    let betEnabled = false;

    function pgsiMixAmongGamblers(age, sex){
      const base = PGSI_BY_SEX[sex] || PGSI_BY_SEX.male;
      const m = { ...base };

      let ageMult;
      if (age <= 21) ageMult = YOUNG_MULT;
      else if (age >= 78) ageMult = OLD_MULT;
      else ageMult = lerp(YOUNG_MULT, OLD_MULT, (age - 21) / (78 - 21));

      m.prob_8p = clamp(m.prob_8p * ageMult, 0, 0.35);

      const scale = (1 - m.prob_8p) / (1 - base.prob_8p);
      m.low_1_2 *= scale;
      m.mod_3_7 *= scale;

      m.pgsi_0 = clamp(1 - (m.low_1_2 + m.mod_3_7 + m.prob_8p), 0, 1);
      return m;
    }

    function mapToLossBands(m){
      const p34 = m.mod_3_7 * (2/5);
      const p57 = m.mod_3_7 * (3/5);
      return { p0:m.pgsi_0, p14:m.low_1_2 + p34, p5p:p57 + m.prob_8p };
    }

    function blendedLoss(poundsAnchor, income, pctAnchor){
      if (!(income > 0)) return poundsAnchor;
      const incomeBased = income * pctAnchor;

      const t = clamp((income - 1000) / 9000, 0, 1);
      const wAnchor = t;
      const wIncome = 1 - t;

      const a = Math.max(1e-9, poundsAnchor);
      const b = Math.max(1e-9, incomeBased);
      return Math.exp(Math.log(a)*wAnchor + Math.log(b)*wIncome);
    }

    function expectedLossDemographic(mix, income){
      const { p0, p14, p5p } = mapToLossBands(mix);
      const loss0  = LOSS_PGSI0;
      const loss14 = blendedLoss(LOSS_PGSI1_4, income, AT_RISK_LOSS_PCT_INCOME);
      const loss5p = blendedLoss(LOSS_PGSI5P,  income, HIGH_RISK_LOSS_PCT_INCOME);
      return p0*loss0 + p14*loss14 + p5p*loss5p;
    }

    function expectedLossFromTurnover(betPerWeek, lossRate){
      const turnover = Math.max(0, betPerWeek) * 52;
      return turnover * clamp(lossRate, 0, 0.40);
    }

    function applyCaps(expLoss, income, betPerWeek){
      const caps = [];
      let x = expLoss;

      if (betPerWeek > 0){
        const stakeCap = betPerWeek * 52;
        if (x > stakeCap){ x = stakeCap; caps.push("stake/yr"); }
      }
      if (income > 0 && income < 2000){
        const incomeCap = income * 0.60;
        if (x > incomeCap){ x = incomeCap; caps.push("low-income"); }
      }
      if (income > 0){
        const hard = income * 2.0;
        if (x > hard){ x = hard; caps.push("hard-income"); }
      }
      return { value:x, caps: caps.length ? caps.join("+") : "none" };
    }

    function outcomeBand(exp){ return [exp*0.4, exp*2.0]; }
    function fmtGBP0(x){ return "£" + x.toLocaleString(undefined, { maximumFractionDigits: 0 }); }

    function renderSportPipes(selectedKey){
      const g = $("sportPipes");
      g.innerHTML = "";

      const ranked = SPORT_ORDER
        .map(k => ({ key:k, ...SPORT_RISK[k] }))
        .sort((a,b)=>b.rate-a.rate);

      const maxRate = ranked[0].rate;
      const minRate = ranked[ranked.length-1].rate;

      ranked.forEach((s, i) => {
        const y = i * 36;
        const t = (s.rate - minRate) / (maxRate - minRate + 1e-9);

        const row = document.createElementNS("http://www.w3.org/2000/svg","g");
        row.setAttribute("transform", `translate(0,${y})`);

        const label = document.createElementNS("http://www.w3.org/2000/svg","text");
        label.setAttribute("x","0");
        label.setAttribute("y","14");
        label.setAttribute("fill","rgba(255,255,255,.78)");
        label.setAttribute("font-size","12");
        label.setAttribute("font-family","ui-monospace, monospace");
        label.textContent = s.name;

        const pipe = document.createElementNS("http://www.w3.org/2000/svg","rect");
        pipe.setAttribute("x","170");
        pipe.setAttribute("y","5");
        pipe.setAttribute("width","250");
        pipe.setAttribute("height","14");
        pipe.setAttribute("rx","7");
        pipe.setAttribute("fill","rgba(255,255,255,.06)");
        pipe.setAttribute("stroke","rgba(255,255,255,.18)");

        const leak = document.createElementNS("http://www.w3.org/2000/svg","rect");
        leak.setAttribute("x","170");
        leak.setAttribute("y","5");
        leak.setAttribute("width", String(250 * t));
        leak.setAttribute("height","14");
        leak.setAttribute("rx","7");
        leak.setAttribute("fill", s.key === selectedKey ? "rgba(255,255,255,.92)" : "rgba(255,255,255,.62)");

        const pct = document.createElementNS("http://www.w3.org/2000/svg","text");
        pct.setAttribute("x","440");
        pct.setAttribute("y","16");
        pct.setAttribute("fill","rgba(255,255,255,.78)");
        pct.setAttribute("font-size","12");
        pct.setAttribute("font-family","ui-monospace, monospace");
        pct.textContent = `${(s.rate*100).toFixed(1)}%`;

        row.appendChild(label);
        row.appendChild(pipe);
        row.appendChild(leak);
        row.appendChild(pct);
        g.appendChild(row);
      });

      const top = ranked[0];
      $("topRisk").textContent = `Highest leak proxy: ${top.name} (${(top.rate*100).toFixed(1)}%) — ${top.note}`;
      $("riskExplain").textContent = `Selected: ${SPORT_RISK[selectedKey].name} (${(SPORT_RISK[selectedKey].rate*100).toFixed(1)}%)`;
    }

    function setBetUI(){
      $("betSwitch").classList.toggle("on", betEnabled);
      $("betRow").style.display = betEnabled ? "flex" : "none";
      if (!betEnabled) $("betPerWeek").value = "";
    }

    function recalc(){
      const age = Number($("age").value);
      const sex = $("sex").value;
      const income = Number($("income").value);
      const bet = betEnabled ? Number($("betPerWeek").value || 0) : 0;
      const sportKey = $("sportKey").value;
      const rate = SPORT_RISK[sportKey].rate;

      $("ageVal").textContent = String(age);
      renderSportPipes(sportKey);

      const mix = pgsiMixAmongGamblers(age, sex);
      let exp, modeLine;

      if (betEnabled && bet > 0){
        exp = expectedLossFromTurnover(bet, rate);
        modeLine = `Mode: stake/week × lossRate (${(rate*100).toFixed(1)}%)`;
      } else {
        exp = expectedLossDemographic(mix, income);
        modeLine = `Mode: demographic fallback (stake/week OFF)`;
      }

      const capped = applyCaps(exp, income, bet);
      exp = capped.value;

      const [lo, hi] = outcomeBand(exp);
      $("expLoss").textContent = fmtGBP0(exp);
      $("band").textContent = `${fmtGBP0(lo)} — ${fmtGBP0(hi)} (loose band)`;
      $("modeLine").textContent = modeLine;
      $("capLine").textContent = `CAPS: ${capped.caps}`;

      const pos = clamp((exp - lo) / (hi - lo), 0, 1);
      $("posBar").style.width = (pos * 100).toFixed(1) + "%";

      if (income > 0){
        const pct = exp / income;
        $("pctIncome").textContent = (pct * 100).toFixed(2) + "%";
        $("pctBar").style.width = (clamp(pct / 0.12, 0, 1) * 100).toFixed(1) + "%";
      } else {
        $("pctIncome").textContent = "—";
        $("pctBar").style.width = "0%";
      }

      $("bananaLine").innerHTML = `You could buy: <span style="font-family:var(--mono); color:rgba(255,255,255,.88)">${bananasFromLoss(exp)} bananas</span> 🍌`;
    }

    // ---------------- Sounds (no external files) ----------------
    // Uses WebAudio so it works on GitHub Pages without assets.
    let audioEnabled = false;
    let audioCtx = null;
    let master = null;
    let gallopTimer = null;

    function ensureAudio(){
      if (!audioCtx){
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        master = audioCtx.createGain();
        master.gain.value = 0.65;
        master.connect(audioCtx.destination);
      }
      if (audioCtx.state === "suspended") audioCtx.resume();
    }

    function beep(freq, dur=0.08, type="sine", gain=0.18){
      if (!audioEnabled) return;
      ensureAudio();
      const t = audioCtx.currentTime;

      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type;
      o.frequency.setValueAtTime(freq, t);

      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(gain, t+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t+dur);

      o.connect(g); g.connect(master);
      o.start(t);
      o.stop(t + dur + 0.02);
    }

    function noiseBurst(dur=0.10, gain=0.12){
      if (!audioEnabled) return;
      ensureAudio();
      const t = audioCtx.currentTime;
      const bufferSize = Math.floor(audioCtx.sampleRate * dur);
      const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const data = buffer.getChannelData(0);
      for (let i=0;i<bufferSize;i++){
        data[i] = (Math.random()*2-1) * (1 - i/bufferSize);
      }
      const src = audioCtx.createBufferSource();
      const g = audioCtx.createGain();
      g.gain.value = gain;
      src.buffer = buffer;
      src.connect(g); g.connect(master);
      src.start(t);
      src.stop(t + dur);
    }

    function startGallop(rateMs=140){
      if (!audioEnabled) return;
      stopGallop();
      ensureAudio();
      gallopTimer = setInterval(() => {
        // two hoof hits: low thump + higher click
        beep(90, 0.045, "triangle", 0.12);
        setTimeout(()=>beep(220, 0.03, "square", 0.06), 28);
      }, rateMs);
    }
    function stopGallop(){
      if (gallopTimer){ clearInterval(gallopTimer); gallopTimer = null; }
    }

    function winSound(){
      if (!audioEnabled) return;
      ensureAudio();
      beep(440,0.08,"sine",0.12);
      setTimeout(()=>beep(660,0.08,"sine",0.12),90);
      setTimeout(()=>beep(880,0.10,"sine",0.12),180);
      setTimeout(()=>noiseBurst(0.14,0.10), 210);
    }
    function loseSound(){
      if (!audioEnabled) return;
      ensureAudio();
      beep(220,0.10,"sawtooth",0.10);
      setTimeout(()=>beep(160,0.14,"sawtooth",0.10),90);
      setTimeout(()=>noiseBurst(0.08,0.10), 120);
    }
    function clickSound(){
      if (!audioEnabled) return;
      ensureAudio();
      beep(520,0.03,"square",0.05);
    }

    // ---------------- Fullscreen Race Game ----------------
    let bank = 100;
    let races = 0;
    let totalStaked = 0;

    let trueProbs = [0.25, 0.22, 0.20, 0.18, 0.15];
    let bookOdds  = [3.0, 3.5, 4.0, 4.5, 5.0];

    function randDirichlet5(){
      const g = Array.from({length:5}, () => -Math.log(Math.max(1e-9, Math.random())));
      const s = g.reduce((a,b)=>a+b,0);
      return g.map(x=>x/s);
    }
    function computeBookOdds(overround){
      const q = trueProbs.map(p => p * overround);
      return q.map(x => 1 / x);
    }
    function fmtDecOdds(x){ return x.toFixed(2) + "x"; }

    function updateRaceUI(){
      $("o0").textContent = fmtDecOdds(bookOdds[0]);
      $("o1").textContent = fmtDecOdds(bookOdds[1]);
      $("o2").textContent = fmtDecOdds(bookOdds[2]);
      $("o3").textContent = fmtDecOdds(bookOdds[3]);
      $("o4").textContent = fmtDecOdds(bookOdds[4]);
      $("oddsBanner").textContent = `Overround: ${(Number($("overround").value)*100).toFixed(0)}%`;
    }

    function chooseWinner(){
      const r = Math.random();
      let cum = 0;
      for (let i=0;i<trueProbs.length;i++){
        cum += trueProbs[i];
        if (r <= cum) return i;
      }
      return 4;
    }

    function resetHorses(){
      for (let i=0;i<5;i++){
        const h = $("h"+i);
        h.classList.remove("run");
        h.style.transition = "";
        h.style.transform = "translateX(0px)";
      }
    }

    function clearMoney(){
      document.querySelectorAll(".money").forEach(el => el.remove());
    }

    function moneyStream(fromEl, toEl, count, ms){
      const track = $("track");
      const tr = track.getBoundingClientRect();
      const a = fromEl.getBoundingClientRect();
      const b = toEl.getBoundingClientRect();

      const fromX = a.left + a.width*0.5;
      const fromY = a.top  + a.height*0.5;
      const toX   = b.left + b.width*0.5;
      const toY   = b.top  + b.height*0.5;

      for (let i=0;i<count;i++){
        const m = document.createElement("div");
        m.className = "money";
        track.appendChild(m);

        const sx = fromX - tr.left + (Math.random()*12 - 6);
        const sy = fromY - tr.top  + (Math.random()*12 - 6);
        const tx = toX   - tr.left + (Math.random()*18 - 9);
        const ty = toY   - tr.top  + (Math.random()*18 - 9);

        const delay = i * (ms / count) * 0.16;

        m.style.left = sx + "px";
        m.style.top  = sy + "px";

        requestAnimationFrame(() => {
          m.style.transition =
            `transform ${ms}ms cubic-bezier(.2,.9,.2,1) ${delay}ms, opacity 180ms ease ${delay}ms`;
          m.style.opacity = "0.95";
          m.style.transform = `translate(${(tx - sx).toFixed(0)}px, ${(ty - sy).toFixed(0)}px)`;
        });

        setTimeout(() => { m.style.opacity = "0"; }, delay + ms - 160);
        setTimeout(() => m.remove(), delay + ms + 240);
      }
    }

    function popConfetti(){
      const c = $("confetti");
      c.innerHTML = "";
      c.classList.add("on");
      const colors = ["#ff4d4d","#4dd2ff","#ffe14d","#a84dff","#4dff88"];
      for (let i=0;i<30;i++){
        const p = document.createElement("i");
        const left = Math.random()*100;
        const delay = Math.random()*120;
        const dur = 760 + Math.random()*480;
        p.style.left = left + "%";
        p.style.background = colors[i % colors.length];
        p.style.animationDuration = dur + "ms";
        p.style.animationDelay = delay + "ms";
        c.appendChild(p);
      }
      setTimeout(() => c.classList.remove("on"), 1200);
    }

    function settleBet(pick, stake, winner){
      races += 1;
      totalStaked += stake;
      bank -= stake;

      const win = (pick === winner);
      let payout = 0;

      if (win){
        payout = stake * (bookOdds[winner] - 1);
        bank += stake + payout;
      }

      $("bank").textContent = "£" + bank.toFixed(2);
      $("races").textContent = String(races);

      const roi = totalStaked > 0 ? ((bank - 100) / totalStaked) * 100 : 0;
      $("roi").textContent = roi.toFixed(2) + "%";

      $("lastResult").textContent = win
        ? `Last: WIN (Horse ${winner+1}) +£${payout.toFixed(2)}`
        : `Last: LOSS (Horse ${winner+1})`;

      const bookie = $("bookie");
      bookie.classList.remove("pay","take");
      void bookie.offsetWidth;

      const bankEl = $("bank");
      if (win){
        bookie.classList.add("pay");
        moneyStream(bookie, bankEl, 18, 760);
        popConfetti();
        winSound();
      } else {
        bookie.classList.add("take");
        moneyStream(bankEl, bookie, 14, 620);
        loseSound();
      }
    }

    function runRaceAnimated(pick, stake, opts={ hyper:false }){
      clearMoney();

      const winner = chooseWinner();
      const track = $("track");
      const finishX = track.clientWidth - 220 - 260;
      const base = Math.max(240, finishX);

      const durations = [];
      for (let i=0;i<5;i++){
        const noise = (Math.random() * 0.26) + 0.95;
        const winBoost = (i === winner) ? 0.86 : 1.0;
        durations[i] = (opts.hyper ? 620 : 1700) * noise * winBoost;
      }

      track.classList.toggle("hyper", !!opts.hyper);

      // start gallop sound: faster in hyper
      startGallop(opts.hyper ? 80 : 140);

      for (let i=0;i<5;i++){
        const h = $("h"+i);
        h.classList.add("run");
        h.style.transition = `transform ${durations[i].toFixed(0)}ms cubic-bezier(.18,.88,.18,1)`;
        h.style.transform = `translateX(${base}px)`;
      }

      const settleIn = Math.max(...durations) + 40;
      setTimeout(() => {
        stopGallop();
        settleBet(pick, stake, winner);
        setTimeout(() => {
          track.classList.remove("hyper");
          resetHorses();
        }, 520);
      }, settleIn);
    }

    function runSimFast(n){
      const pick = Number($("pickHorse").value);
      const stake = Math.max(1, Number($("stake").value || 1));
      const track = $("track");

      // short "super rapid running" burst, then compute instantly
      track.classList.add("hyper");
      for (let i=0;i<5;i++) $("h"+i).classList.add("run");
      startGallop(70);

      const burstMs = clamp(500 + Math.log10(Math.max(10,n))*250, 650, 1400);

      setTimeout(() => {
        stopGallop();

        // compute results (instant)
        for (let i=0;i<n;i++){
          const winner = chooseWinner();
          races += 1;
          totalStaked += stake;
          bank -= stake;
          if (pick === winner){
            const payout = stake * (bookOdds[winner] - 1);
            bank += stake + payout;
          }
        }

        $("bank").textContent = "£" + bank.toFixed(2);
        $("races").textContent = String(races);
        const roi = totalStaked > 0 ? ((bank - 100) / totalStaked) * 100 : 0;
        $("roi").textContent = roi.toFixed(2) + "%";
        $("lastResult").textContent = `Last: simulated ${n.toLocaleString()} races`;

        // end visuals
        track.classList.remove("hyper");
        resetHorses();

        // tiny "result" sound
        if (audioEnabled){
          clickSound();
          setTimeout(()=>beep(320,0.05,"triangle",0.06), 60);
        }
      }, burstMs);
    }

    function resetGame(){
      bank = 100;
      races = 0;
      totalStaked = 0;

      trueProbs = randDirichlet5().map(p => 0.06 + 0.94*p);
      const s = trueProbs.reduce((a,b)=>a+b,0);
      trueProbs = trueProbs.map(x=>x/s);

      const ov = Number($("overround").value);
      bookOdds = computeBookOdds(ov);

      $("bank").textContent = "£" + bank.toFixed(2);
      $("races").textContent = "0";
      $("roi").textContent = "0.00%";
      $("lastResult").textContent = "Last: —";
      updateRaceUI();
      clearMoney();
      resetHorses();
    }

    // spectators
    function buildCrowd(){
      const crowd = $("crowd");
      crowd.innerHTML = "";
      const n = 150;
      for (let i=0;i<n;i++){
        const p = document.createElement("i");
        p.style.left = (Math.random()*100) + "%";
        p.style.height = (8 + Math.random()*14).toFixed(0) + "px";
        p.style.width  = (4 + Math.random()*5).toFixed(0) + "px";
        p.style.animationDelay = (Math.random()*520).toFixed(0) + "ms";
        p.style.opacity = (0.25 + Math.random()*0.55).toFixed(2);
        crowd.appendChild(p);
      }
    }

    // ---------------- Wire inputs ----------------
    $("betSwitch").addEventListener("click", () => {
      betEnabled = !betEnabled;
      setBetUI();
      recalc();
      clickSound();
    });
    $("betPerWeek").addEventListener("input", recalc);
    $("sportKey").addEventListener("change", () => { recalc(); clickSound(); });
    $("income").addEventListener("input", recalc);
    $("age").addEventListener("input", recalc);
    $("sex").addEventListener("change", () => { recalc(); clickSound(); });

    // ---------------- Wire game ----------------
    $("soundBtn").addEventListener("click", async () => {
      audioEnabled = !audioEnabled;
      const btn = $("soundBtn");
      btn.classList.toggle("on", audioEnabled);
      $("soundLabel").textContent = audioEnabled ? "Sound ON" : "Sound OFF";
      if (audioEnabled){
        ensureAudio();
        // quick “ready” chirp
        beep(520,0.05,"triangle",0.08);
        setTimeout(()=>beep(740,0.06,"triangle",0.08), 60);
      } else {
        stopGallop();
      }
    });

    $("raceBtn").addEventListener("click", () => {
      const pick = Number($("pickHorse").value);
      const stake = Math.max(1, Number($("stake").value || 1));
      clickSound();
      runRaceAnimated(pick, stake, { hyper:false });
    });

    $("runCustomBtn").addEventListener("click", () => {
      const n = clamp(Number($("raceCount").value || 1), 1, 200000);
      $("raceCount").value = String(n);
      clickSound();
      if (n === 1){
        const pick = Number($("pickHorse").value);
        const stake = Math.max(1, Number($("stake").value || 1));
        runRaceAnimated(pick, stake, { hyper:false });
      } else if (n <= 15){
        // For small N, do a quick hyper single animation per run (feels like multiple races)
        const pick = Number($("pickHorse").value);
        const stake = Math.max(1, Number($("stake").value || 1));
        let i = 0;
        const step = () => {
          i++;
          runRaceAnimated(pick, stake, { hyper:true });
          // wait until this mini race settles
          setTimeout(() => { if (i < n) step(); }, 820);
        };
        step();
      } else {
        // For large N, show a rapid “hyper burst” then compute instantly
        runSimFast(n);
      }
    });

    $("resetBankBtn").addEventListener("click", () => {
      clickSound();
      resetGame();
    });

    $("overround").addEventListener("change", () => {
      const ov = Number($("overround").value);
      bookOdds = computeBookOdds(ov);
      updateRaceUI();
      clickSound();
    });

    // ---------------- Init ----------------
    updateHUD();
    setBetUI();
    buildCrowd();
    recalc();
    resetGame();

  </script>
</body>
</html>
